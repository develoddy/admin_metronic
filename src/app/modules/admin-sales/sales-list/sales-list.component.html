<div class="card">
    <div class="card-header">
        <h3 class="card-title">Ventas</h3>
        <div class="card-toolbar">
            <div class="input-group input-group-sm">
                <input class="form-control form-control-sm" placeholder="Buscar ventas" [value]="q" (keyup)="searchTerm.next($event.target.value)" (keyup.enter)="load(1)" />
                <button class="btn btn-sm btn-dark" (click)="load()">Buscar</button>
            </div>
        </div>
    </div>

    <div class="card-body p-0">
        <div class="table-responsive">
            <!-- <table class="table table-row-dashed align-middle gy-4"> -->
            <table class="table table-head-custom table-vertical-center" id="kt_advance_table_widget_1">
                <ng-container *ngIf="sales?.length > 0; else noResults">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>N¬∫ Transacci√≥n</th>
                            <th>Usuario</th>
                            <th>Printful Order ID</th>
                            <th>Printful Status</th>
                            <th>Fecha</th>
                            <th>Total</th>
                            <th>Items</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let s of sales">
                            <td>{{ s.id }}</td>
                            <td style="position: relative; overflow: visible !important" class="position-relative">
                                <div class="d-flex align-items-center gap-2">
                                    <span *ngIf="s.method_payment === 'STRIPE'" class="badge bg-success text-truncate" style="max-width: 150px" [title]="s.n_transaction">
                                        {{ s.n_transaction }}
                                    </span>
                                    <span *ngIf="s.method_payment === 'PAYPAL'" class="badge bg-primary text-truncate" style="max-width: 150px" [title]="s.n_transaction">
                                        {{ s.n_transaction }}
                                    </span>
                                    <!-- Bot√≥n copiar -->
                                    <button class="btn btn-sm btn-light p-2" (click)="copyToClipboard(s.n_transaction, s.id)" title="Copiar n√∫mero de transacci√≥n">
                                        <!-- <i class="bi bi-clipboard"></i> -->
                                        <svg id="Interface_File_Double_24" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                            <rect width="24" height="24" stroke="none" fill="#000000" opacity="0" />

                                            <g transform="matrix(1.43 0 0 1.43 12 12)">
                                                <g style="">
                                                    <g transform="matrix(1 0 0 1 1.25 -1.25)">
                                                        <path style="
                                stroke: rgb(0, 0, 0);
                                stroke-width: 1;
                                stroke-dasharray: none;
                                stroke-linecap: round;
                                stroke-dashoffset: 0;
                                stroke-linejoin: round;
                                stroke-miterlimit: 4;
                                fill: none;
                                fill-rule: nonzero;
                                opacity: 1;
                                " transform=" translate(-8.25, -5.75)" d="M 12.5 10 C 12.5 10.552284749830793 12.052284749830793 11 11.5 11 L 5 11 C 4.447715250169207 11 4 10.552284749830793 4 10 L 4 1.5 C 4 0.9477152501692065 4.447715250169207 0.5 5 0.5 L 9.5 0.5 L 12.5 3.5 Z" stroke-linecap="round" />
                                                    </g>
                                                    <g transform="matrix(1 0 0 1 -1.5 1.5)">
                                                        <path style="
                                stroke: rgb(0, 0, 0);
                                stroke-width: 1;
                                stroke-dasharray: none;
                                stroke-linecap: round;
                                stroke-dashoffset: 0;
                                stroke-linejoin: round;
                                stroke-miterlimit: 4;
                                fill: none;
                                fill-rule: nonzero;
                                opacity: 1;
                                " transform=" translate(-5.5, -8.5)" d="M 9.5 13.5 L 2.5 13.5 C 1.9477152501692065 13.5 1.5 13.052284749830793 1.5 12.5 L 1.5 3.5" stroke-linecap="round" />
                                                    </g>
                                                </g>
                                            </g>
                                        </svg>
                                    </button>
                                </div>

                                <!-- Tooltip -->
                                <div *ngIf="copiedId == s.id" class="copy-tooltip position-absolute bg-dark text-white px-2 py-1 rounded small" style="top: -25px; right: 0; z-index: 1000">
                                    ¬°Copiado!
                                </div>
                            </td>

                            <td>{{(s.user && s.user.email) || (s.guest && s.guest.email) || "‚Äî"}}</td>

                            <td>{{ s.printfulOrderId }}</td>
                            
                            <td>
                                <span class="badge" [ngClass]="{
                                                'bg-secondary': (s.printfulStatus || '') === 'draft' || (s.printfulStatus || '') === 'pending',
                                                'bg-success': (s.printfulStatus || '') === 'fulfilled',
                                                'bg-danger': (s.printfulStatus || '') === 'canceled' || (s.printfulStatus || '') === 'failed'
                                            }">
                                    {{ s.printfulStatus || '‚Äî' }}
                                </span>
                            </td>
                            <td>{{ s.createdAt | date : "short" }}</td>
                            <td>‚Ç¨ {{ s.total }}</td>
                            <td>
                                <div *ngFor="let it of s.items | slice : 0 : 3" class="d-flex align-items-center mb-5">
                                    <img *ngIf="it.imagen" [src]="it.imagen" class="me-2 rounded" style="width: 40px; height: 40px; object-fit: cover" />
                                    <div class="d-flex flex-column">
                                        <div class="px-2 lh-1"><span>{{ it.title }}</span></div>
                                        <div class="px-2 lh-1"><small class="me-2 text-muted" *ngIf="it.sku">SKU:</small><small class="text-muted">{{ it.sku }}</small></div>
                                        <div class="px-2 lh-1"><small class="me-2 text-muted">Talla:</small> <small class="text-muted" *ngIf="it.talla">{{ it.talla }}</small></div>
                                        <div class="px-2 lh-1"><small class="me-2 text-muted">color:</small> <small class="text-muted" *ngIf="it.color">{{ it.color }}</small></div>
                                        <div class="px-2 lh-1"><small class="me-2 text-muted">Cantidad:</small><small class="text-muted">{{ it.cantidad }}</small></div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-end">
                                <div class="dropdown d-inline-block" style="position: relative;">
                                    <button 
                                    class="btn btn-sm btn-light dropdown-toggle"
                                    (click)="toggleActions($event, s.id)">
                                    Actions
                                    </button>

                                    <!-- Dropdown -->
                                    <div 
                                    *ngIf="openDropdownId === s.id"
                                    class="dropdown-menu show shadow bg-white border rounded py-2"
                                    style="position: absolute; left: 50%; transform: translateX(-76%); top: 100%; min-width: 160px; z-index: 1050;"
                                    (click)="$event.stopPropagation()">
                                    
                                    <button class="dropdown-item" (click)="viewSale(s); closeDropdown()">üëÅÔ∏è Ver</button>
                                    <button class="dropdown-item" (click)="downloadReceipt(s); closeDropdown()">üßæ Recibo</button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </ng-container>
                <ng-template #noResults>
                    <tr>
                        <td colspan="4" class="text-center text-muted fw-bold">
                            No se encontr√≥ ning√∫na venta con los criterios de b√∫squeda.
                        </td>
                    </tr>
                </ng-template>
            </table>
        </div>
    </div>

    <!-- Paginaci√≥n estilo Metronic / Bootstrap -->
    <nav class="clearfix pagination-bottom" *ngIf="totalPages > 1">
        <ul class="pagination justify-content-center">
            <li class="page-item" [class.disabled]="currentPage === 1">
                <a class="page-link" href="#" (click)="prevPage(); $event.preventDefault()">
                    <i class="icon anm anm-angle-left-l"></i>
                </a>
            </li>

            <li class="page-item" *ngFor="let page of pages" [class.active]="currentPage === page">
                <a class="page-link" href="#" (click)="goToPage(page); $event.preventDefault()">{{ page }}</a>
            </li>

            <li class="page-item" [class.disabled]="currentPage === totalPages">
                <a class="page-link" href="#" (click)="nextPage(); $event.preventDefault()">
                    <i class="icon anm anm-angle-right-l"></i>
                </a>
            </li>
        </ul>
    </nav>
</div>