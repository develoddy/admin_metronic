<div class="card card-custom gutter-b">
  <div class="card-header">
    <div class="card-title">
      <h3 class="card-label">
        <i class="icon-2x text-dark-50 flaticon-list mx-2"></i> Lista de Productos
      </h3>
    </div>
    <div class="card-toolbar">
      <a
        type="button"
        class="btn btn-primary"
        routerLink="/products/register-product"
      >
        <i class="icon-2x text-white flaticon-imac"></i> Nuevo Producto
      </a>
    </div>
  </div>

  <div class="card-body">
    <ng-container *ngIf="isLoading$ | async">
      <span class="spinner spinner-primary ml-5"></span>
    </ng-container>

    <!-- Filtros -->
    <div class="form form-label-right mb-4">
      <div class="form-group row align-items-end">
        <!-- Buscador -->
        <div class="col-12 col-lg-3 mb-2 mb-lg-0">
          <input
            type="text"
            class="form-control form-control-sm"
            placeholder="Buscar productos"
            [(ngModel)]="search"
            (ngModelChange)="onSearchChange($event)"
            (keyup.enter)="allProducts()"
          />
          <small class="form-text text-muted">
            <b>Buscar</b> por nombre, SKU o categoría
          </small>
        </div>

        <!-- Categorías -->
        <div class="col-12 col-lg-3 mb-2 mb-lg-0">
          <select
            class="form-control"
            [(ngModel)]="categorie"
            name="categorie"
            (change)="onCategoryChange($event)"
          >
            <option value="">Ninguno</option>
            <ng-container *ngFor="let item of categories">
              <option [value]="item._id">{{ item.title }}</option>
            </ng-container>
          </select>
          <small class="form-text text-muted">
            <b>Buscar</b> por categoría
          </small>
        </div>

        <!-- Botones -->
        <div class="col-12 col-lg-4 mt-2 mt-lg-0">
          <button class="btn btn-primary px-3" (click)="allProducts()">
            Buscar
          </button>
          <button class="btn btn-dark ml-3" (click)="refresh()">
            Actualizar
          </button>
          <button
            class="btn btn-success ml-3 d-none"
            (click)="synPrintful()"
          >
            Sincronizar con Printful
          </button>
        </div>

        <!-- Total productos -->
        <div class="col-12 col-lg-2 mt-3 mt-lg-0 text-lg-right text-muted">
          <span class="fw-bold">
            Total Productos: 
            <span class="text-dark">{{ total }}</span>
          </span>
        </div>
      </div>
    </div>

    <!-- Tabla de productos -->
    <div class="table-responsive">
      <table class="table table-hover table-bordered align-middle text-center">
        <thead class="thead-light">
          <tr>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>SKU</th>
            <th>Categoría</th>
            <th>Precio (PEN)</th>
            <th>Precio (USD)</th>
            <th>Logo</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let product of pagedProducts">
            <!-- Imagen -->
            <td>
              <img
                [src]="product.imagen"
                alt="{{ product.title }}"
                class="rounded"
                style="width: 60px; height: 60px; object-fit: cover;"
              />
            </td>

            <!-- Nombre -->
            <td class="text-truncate" style="max-width: 180px;">
              {{ product.title }}
            </td>

            <!-- SKU -->
            <td>{{ product.sku }}</td>

            <!-- Categoría -->
            <td>
              {{
                product.categorie
                  ? product.categorie.title
                  : 'Sin categoría'
              }}
            </td>

            <!-- Precio -->
            <td>{{ product.price_eur || product.price || product.price_usd || '-' }} €</td>

            <!-- Logo -->
            <td>{{ product.logo_position }}</td>

            <!-- Estado -->
            <td>
              <span
                class="badge"
                [ngClass]="{
                  'badge-warning': product.state === 1,
                  'badge-success': product.state === 2,
                  'badge-danger': product.state === 3
                }"
              >
                {{
                  product.state === 1
                    ? 'Ignorado'
                    : product.state === 2
                    ? 'Publicado'
                    : 'Anulado'
                }}
              </span>
            </td>

            <!-- Acciones -->
            <td>
              <button
                (click)="editProduct(product)"
                class="btn btn-sm btn-light-primary mx-1"
                ngbTooltip="Editar"
              >
                <i class="fa fa-edit"></i>
              </button>
              <button
                (click)="delete(product)"
                class="btn btn-sm btn-light-danger mx-1"
                ngbTooltip="Eliminar"
              >
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <nav *ngIf="totalPages > 1" class="mt-3">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a
            href="#"
            class="page-link"
            (click)="prevPage(); $event.preventDefault()"
          >
            <i class="icon anm anm-angle-left-l"></i>
          </a>
        </li>

        <li
          class="page-item"
          *ngFor="let page of [].constructor(totalPages); let i = index"
          [class.active]="currentPage === i + 1"
        >
          <a
            href="#"
            class="page-link"
            (click)="goToPage(i + 1); $event.preventDefault()"
          >
            {{ i + 1 }}
          </a>
        </li>

        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <a
            href="#"
            class="page-link"
            (click)="nextPage(); $event.preventDefault()"
          >
            <i class="icon anm anm-angle-right-l"></i>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>
