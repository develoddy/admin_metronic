<div class="mvp-analytics-container">
  
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h2 class="page-title">
        <i class="fas fa-brain text-primary me-2"></i>
        MVP Analytics
      </h2>
      <p class="page-subtitle">Automated Decision Engine for Micro-SaaS</p>
    </div>
    <div class="header-right">
      <button class="btn btn-outline-primary btn-sm" (click)="refresh()" [disabled]="isLoading">
        <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="filter-group">
      <label class="filter-label">Period:</label>
      <div class="btn-group btn-group-sm" role="group">
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          [class.active]="selectedPeriod === '7d'"
          (click)="changePeriod('7d')">
          7 days
        </button>
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          [class.active]="selectedPeriod === '30d'"
          (click)="changePeriod('30d')">
          30 days
        </button>
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          [class.active]="selectedPeriod === '90d'"
          (click)="changePeriod('90d')">
          90 days
        </button>
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          [class.active]="selectedPeriod === 'all'"
          (click)="changePeriod('all')">
          All
        </button>
      </div>
    </div>

    <div class="filter-group">
      <label class="filter-label">Score:</label>
      <div class="btn-group btn-group-sm" role="group">
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          [class.active]="selectedFilter === 'all'"
          (click)="changeFilter('all')">
          All
        </button>
        <button 
          type="button" 
          class="btn btn-outline-success"
          [class.active]="selectedFilter === 'high'"
          (click)="changeFilter('high')">
          High (‚â•70)
        </button>
        <button 
          type="button" 
          class="btn btn-outline-warning"
          [class.active]="selectedFilter === 'medium'"
          (click)="changeFilter('medium')">
          Medium (40-69)
        </button>
        <button 
          type="button" 
          class="btn btn-outline-danger"
          [class.active]="selectedFilter === 'low'"
          (click)="changeFilter('low')">
          Low (<40)
        </button>
      </div>
    </div>

    <div class="filter-group ms-auto">
      <input 
        type="text" 
        class="form-control form-control-sm"
        placeholder="üîç Search MVP..."
        [(ngModel)]="searchTerm">
    </div>

    <!-- Toggle Concept View -->
    <div class="filter-group ms-2">
      <button 
        class="btn btn-sm"
        [ngClass]="groupByConcept ? 'btn-primary' : 'btn-outline-secondary'"
        (click)="toggleConceptView()"
        title="Group by concept family">
        <i class="fas" [ngClass]="groupByConcept ? 'fa-sitemap' : 'fa-th'"></i>
        {{ groupByConcept ? 'Concept View' : 'Normal View' }}
      </button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards" *ngIf="summary">
    <div class="summary-card">
      <div class="card-icon bg-primary">
        <i class="fas fa-rocket"></i>
      </div>
      <div class="card-content">
        <div class="card-value">{{ summary.total_modules }}</div>
        <div class="card-label">Active MVPs</div>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon bg-success">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="card-content">
        <div class="card-value">{{ summary.ready_to_promote }}</div>
        <div class="card-label">Ready for Module</div>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon bg-warning">
        <i class="fas fa-wrench"></i>
      </div>
      <div class="card-content">
        <div class="card-value">{{ summary.needs_improvement }}</div>
        <div class="card-label">Needs Improvement</div>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon bg-info">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="card-content">
        <div class="card-value">{{ summary.avg_score }}</div>
        <div class="card-label">Average Score</div>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon bg-danger">
        <i class="fas fa-archive"></i>
      </div>
      <div class="card-content">
        <div class="card-value">{{ summary.to_archive }}</div>
        <div class="card-label">To Archive</div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading && analytics.length === 0">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Analyzing micro-SaaS...</p>
  </div>

  <!-- Error State -->
  <div class="alert alert-danger" *ngIf="error">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error }}
  </div>

  <!-- No Data State -->
  <div class="empty-state" *ngIf="!isLoading && filteredAnalytics.length === 0">
    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
    <p class="text-muted mb-0">
      No micro-SaaS with tracking data in this period.
    </p>
  </div>

  <!-- MVP Analytics Grid - Normal View -->
  <div class="mvp-grid" *ngIf="!groupByConcept && filteredAnalytics.length > 0">
    <div 
      class="mvp-card" 
      *ngFor="let mvp of filteredAnalytics"
      [class.high-score]="mvp.healthScore >= 70"
      [class.medium-score]="mvp.healthScore >= 40 && mvp.healthScore < 70"
      [class.low-score]="mvp.healthScore < 40">
      
      <!-- Header -->
      <div class="mvp-card-header">
        <div class="mvp-title">
          <h5>{{ mvp.moduleName }}</h5>
          <small class="text-muted">{{ mvp.moduleKey }}</small>
          
          <!-- Badge for insufficient data -->
          <span class="badge badge-warning badge-sm mt-1" *ngIf="mvp.insufficient_data">
            ‚ö†Ô∏è Low Data
          </span>
          
          <!-- Badge for validation stage / phase -->
          <span 
            class="badge badge-sm mt-1" 
            [ngClass]="{
              'badge-info': mvp.moduleType === 'landing',
              'badge-primary': mvp.moduleType === 'wizard',
              'badge-success': mvp.moduleType === 'live'
            }">
            <ng-container *ngIf="mvp.moduleType === 'landing'">üèñÔ∏è Landing</ng-container>
            <ng-container *ngIf="mvp.moduleType === 'wizard'">üßô Wizard</ng-container>
            <ng-container *ngIf="mvp.moduleType === 'live'">üöÄ Live</ng-container>
          </span>
          
          <!-- Phase indicator (if part of multi-phase concept) -->
          <span 
            class="badge badge-secondary badge-sm mt-1" 
            *ngIf="mvp.conceptName && mvp.phaseOrder !== undefined"
            title="Phase {{ mvp.phaseOrder }} of concept '{{ mvp.conceptName }}'">
            Phase {{ mvp.phaseOrder }}
          </span>
        </div>
        <div class="mvp-recommendation">
          <span class="badge" [ngClass]="getActionBadge(mvp.recommendation.action)">
            {{ getRecommendationIcon(mvp.recommendation.action) }}
            {{ mvp.recommendation.action === 'validate' ? 'Validate' :
               mvp.recommendation.action === 'continue' ? 'Continue' : 'Archive' }}
          </span>
        </div>
      </div>

      <!-- Health Score -->
      <div class="health-score-container">
        <div class="score-label">Health Score</div>
        <div class="score-value" [ngClass]="'text-' + getScoreClass(mvp.healthScore)">
          {{ mvp.healthScore }}
          <small>/100</small>
        </div>
        <div class="progress" style="height: 8px;">
          <div 
            class="progress-bar" 
            [ngClass]="'bg-' + getScoreClass(mvp.healthScore)"
            [style.width.%]="mvp.healthScore"
            role="progressbar">
          </div>
        </div>
      </div>

      <!-- KPIs Grid -->
      <div class="kpis-grid">

        <!-- Sessions ‚Äî shown for both landing & wizard -->
        <div class="kpi-item">
          <div class="kpi-icon">üìä</div>
          <div class="kpi-content">
            <div class="kpi-value">{{ mvp.totalSessions }}</div>
            <div class="kpi-label">Sessions</div>
            <div class="kpi-trend" *ngIf="mvp.trends">
              <span [ngClass]="formatTrend(mvp.trends.sessions_change).class">
                {{ formatTrend(mvp.trends.sessions_change).icon }}
                {{ formatTrend(mvp.trends.sessions_change).text }}
              </span>
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ WIZARD KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <ng-container *ngIf="mvp.moduleType !== 'landing'">
          <div class="kpi-item">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-content">
              <div class="kpi-value">{{ mvp.wizard_completions }}</div>
              <div class="kpi-label">Completed</div>
              <div class="kpi-trend" *ngIf="mvp.trends">
                <span [ngClass]="formatTrend(mvp.trends.completions_change).class">
                  {{ formatTrend(mvp.trends.completions_change).icon }}
                  {{ formatTrend(mvp.trends.completions_change).text }}
                </span>
              </div>
            </div>
          </div>

          <div class="kpi-item">
            <div class="kpi-icon">üì•</div>
            <div class="kpi-content">
              <div class="kpi-value">{{ mvp.downloads }}</div>
              <div class="kpi-label">Downloads</div>
              <div class="kpi-trend" *ngIf="mvp.trends">
                <span [ngClass]="formatTrend(mvp.trends.downloads_change).class">
                  {{ formatTrend(mvp.trends.downloads_change).icon }}
                  {{ formatTrend(mvp.trends.downloads_change).text }}
                </span>
              </div>
            </div>
          </div>

          <div class="kpi-item">
            <div class="kpi-icon">{{ mvp.helpful_rate >= 70 ? 'üòä' : mvp.helpful_rate >= 50 ? 'üòê' : 'üòû' }}</div>
            <div class="kpi-content">
              <div class="kpi-value">{{ mvp.helpful_rate }}%</div>
              <div class="kpi-label">Feedback +</div>
            </div>
          </div>
        </ng-container>

        <!-- ‚îÄ‚îÄ LANDING KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <ng-container *ngIf="mvp.moduleType === 'landing'">
          <div class="kpi-item">
            <div class="kpi-icon">üñ±Ô∏è</div>
            <div class="kpi-content">
              <div class="kpi-value">{{ (mvp.landing_metrics?.engagement_rate || 0) }}%</div>
              <div class="kpi-label">Engagement</div>
              <small class="text-muted">{{ (mvp.landing_metrics?.avg_clicks_per_view || 0) }} avg clicks/user</small>
            </div>
          </div>

          <div class="kpi-item">
            <div class="kpi-icon">üìã</div>
            <div class="kpi-content">
              <div class="kpi-value">{{ (mvp.landing_metrics?.waitlist_signups || 0) }}</div>
              <div class="kpi-label">Waitlist</div>
            </div>
          </div>

          <div class="kpi-item">
            <div class="kpi-icon">{{ (mvp.landing_metrics?.waitlist_conversion || 0) >= 10 ? 'üî•' : (mvp.landing_metrics?.waitlist_conversion || 0) >= 3 ? 'üìà' : '‚ûñ' }}</div>
            <div class="kpi-content">
              <div class="kpi-value">{{ (mvp.landing_metrics?.waitlist_conversion || 0) }}%</div>
              <div class="kpi-label">Conversion</div>
            </div>
          </div>
        </ng-container>

      </div>

      <!-- Pain Resonance section ‚Äî only for landing modules -->
      <div class="pain-resonance-section" *ngIf="mvp.moduleType === 'landing' && mvp.landing_metrics?.top_pain_points?.length">
        <div class="section-title">
          <i class="fas fa-fire text-danger me-1"></i>
          <span>Pain Resonance</span>
        </div>
        <div class="pain-list">
          <div
            class="pain-item"
            *ngFor="let pain of mvp.landing_metrics!.top_pain_points.slice(0, 3)">
            <span class="pain-label">{{ pain.metric }}</span>
            <span class="badge badge-secondary pain-clicks">{{ pain.clicks }}</span>
          </div>
        </div>
      </div>

      <!-- Monetization Metrics (Nuevo: Feb 2026) ‚Äî wizard modules only -->
      <div class="monetization-section" *ngIf="mvp.moduleType !== 'landing' && mvp.monetization_intent_count > 0">
        <div class="section-title">
          <i class="fas fa-coins text-warning me-1"></i>
          <span>Monetization Validation</span>
        </div>
        <div class="monetization-metrics">
          <div class="metric-item">
            <div class="metric-label">Intent Clicks</div>
            <div class="metric-value">{{ mvp.monetization_intent_count }}</div>
            <div class="metric-percentage text-muted">
              {{ mvp.preview_to_intent_rate }}% of completions
            </div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Emails Captured</div>
            <div class="metric-value text-success">{{ mvp.pro_email_submitted_count }}</div>
            <div class="metric-percentage" 
                 [ngClass]="mvp.intent_to_email_rate >= 30 ? 'text-success' : 'text-warning'">
              {{ mvp.intent_to_email_rate }}% conversion
              <i class="fas fa-check-circle ms-1" *ngIf="mvp.intent_to_email_rate >= 30"></i>
            </div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Drop-offs</div>
            <div class="metric-value text-danger">{{ mvp.pro_modal_dismissed_count }}</div>
            <div class="metric-percentage text-muted">
              {{ mvp.modal_dismissal_rate }}% dismissed
            </div>
          </div>
        </div>
        <div class="monetization-insight">
          <i class="fas fa-lightbulb text-warning me-1"></i>
          <span *ngIf="mvp.intent_to_email_rate >= 30" class="text-success">
            ‚úÖ Strong willingness to pay detected
          </span>
          <span *ngIf="mvp.intent_to_email_rate < 30 && mvp.intent_to_email_rate >= 15" class="text-warning">
            ‚ö†Ô∏è Moderate interest - optimize offer
          </span>
          <span *ngIf="mvp.intent_to_email_rate < 15" class="text-danger">
            ‚ùå Low conversion - rethink pricing/value prop
          </span>
        </div>
      </div>
      
      <!-- Alerts -->
      <div class="alerts-section" *ngIf="mvp.alerts && mvp.alerts.length > 0">
        <div 
          class="alert-badge" 
          *ngFor="let alert of mvp.alerts.slice(0, 2)"
          [ngClass]="'alert-' + alert.type">
          <i class="fas fa-info-circle me-1"></i>
          {{ alert.title }}
        </div>
      </div>

      <!-- Footer -->
      <div class="mvp-card-footer">
        <small class="text-muted">
          <i class="fas fa-calendar-alt me-1"></i>
          {{ getPeriodLabel(mvp.period) }}
        </small>
        <div class="action-buttons">
          <!-- Test Button with UTM Dropdown -->
          <div class="btn-group me-2" ngbDropdown placement="bottom-right">
            <button 
              class="btn btn-sm btn-primary"
              (click)="openWizard(mvp.moduleKey, null, $event)"
              title="Open wizard to test MVP (Direct)">
              <i class="fas fa-rocket me-1"></i>
              Test
            </button>
            <button 
              type="button" 
              class="btn btn-sm btn-primary dropdown-toggle dropdown-toggle-split"
              ngbDropdownToggle
              title="Test with different UTM sources">
              <span class="sr-only">Toggle Dropdown</span>
            </button>
            <div class="dropdown-menu" ngbDropdownMenu>
              <h6 class="dropdown-header">
                <i class="fas fa-flask me-1"></i>
                Test as User from...
              </h6>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" (click)="openWizard(mvp.moduleKey, null, $event)">
                <i class="fas fa-home me-2"></i>
                Direct (No UTM)
              </button>
              <button class="dropdown-item" (click)="openWizard(mvp.moduleKey, 'twitter', $event)">
                <i class="fab fa-twitter me-2 text-info"></i>
                Twitter
              </button>
              <button class="dropdown-item" (click)="openWizard(mvp.moduleKey, 'reddit', $event)">
                <i class="fab fa-reddit me-2 text-danger"></i>
                Reddit
              </button>
              <button class="dropdown-item" (click)="openWizard(mvp.moduleKey, 'linkedin', $event)">
                <i class="fab fa-linkedin me-2 text-primary"></i>
                LinkedIn
              </button>
              <button class="dropdown-item" (click)="openWizard(mvp.moduleKey, 'discord', $event)">
                <i class="fab fa-discord me-2 text-indigo"></i>
                Discord
              </button>
              <button class="dropdown-item" (click)="openWizard(mvp.moduleKey, 'indiehackers', $event)">
                <i class="fas fa-rocket me-2 text-warning"></i>
                Indie Hackers
              </button>
              <button class="dropdown-item" (click)="openWizard(mvp.moduleKey, 'producthunt', $event)">
                <i class="fab fa-product-hunt me-2 text-danger"></i>
                Product Hunt
              </button>
            </div>
          </div>
          
          <button 
            class="btn btn-sm btn-outline-secondary"
            (click)="viewDetails(mvp.moduleKey); $event.stopPropagation()"
            title="View detailed metrics">
            <i class="fas fa-chart-line me-1"></i>
            Metrics
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Concept Family View - Grouped by Concept -->
  <div class="concept-family-grid" *ngIf="groupByConcept && filteredAnalytics.length > 0">
    <div 
      class="concept-family-card" 
      *ngFor="let group of conceptGroupsArray">
      
      <!-- Concept Header -->
      <div class="concept-header">
        <div class="concept-title">
          <h5>
            <i class="fas fa-sitemap me-2 text-primary"></i>
            {{ group.conceptName }}
          </h5>
          <span class="badge bg-secondary">{{ group.phases.length }} phase{{ group.phases.length > 1 ? 's' : '' }}</span>
        </div>
        <div class="concept-health">
          <span class="badge" 
            [ngClass]="{
              'bg-success': getCurrentPhase(group.phases).healthScore >= 70,
              'bg-warning': getCurrentPhase(group.phases).healthScore >= 40 && getCurrentPhase(group.phases).healthScore < 70,
              'bg-danger': getCurrentPhase(group.phases).healthScore < 40
            }">
            Current: {{ getCurrentPhase(group.phases).healthScore }} score
          </span>
        </div>
      </div>

      <!-- Phase Timeline -->
      <div class="phase-timeline">
        <div 
          class="phase-item"
          *ngFor="let phase of group.phases; let i = index"
          [class.active]="phase.status === 'live' || phase.status === 'testing'"
          (click)="viewDetails(phase.moduleKey)">
          
          <div class="phase-connector" *ngIf="i > 0"></div>
          
          <div class="phase-badge">
            <span 
              class="badge"
              [ngClass]="{
                'bg-info': phase.moduleType === 'landing',
                'bg-primary': phase.moduleType === 'wizard',
                'bg-success': phase.moduleType === 'live'
              }">
              <ng-container *ngIf="phase.moduleType === 'landing'">üèñÔ∏è Landing</ng-container>
              <ng-container *ngIf="phase.moduleType === 'wizard'">üßô Wizard</ng-container>
              <ng-container *ngIf="phase.moduleType === 'live'">üöÄ Live</ng-container>
            </span>
          </div>

          <div class="phase-content">
            <div class="phase-name">
              <strong>{{ phase.moduleName }}</strong>
              <small class="text-muted d-block">{{ phase.moduleKey }}</small>
            </div>
            
            <div class="phase-status">
              <span class="badge badge-sm" 
                [ngClass]="{
                  'bg-success': phase.status === 'live',
                  'bg-warning': phase.status === 'testing',
                  'bg-secondary': phase.status === 'draft',
                  'bg-dark': phase.status === 'archived'
                }">
                {{ phase.status }}
              </span>
            </div>

            <div class="phase-metrics mt-2">
              <div class="metric-row">
                <span class="metric-label">Health:</span>
                <span class="metric-value" 
                  [ngClass]="{
                    'text-success': phase.healthScore >= 70,
                    'text-warning': phase.healthScore >= 40 && phase.healthScore < 70,
                    'text-danger': phase.healthScore < 40
                  }">
                  {{ phase.healthScore }}
                </span>
              </div>
              
              <div class="metric-row" *ngIf="phase.moduleType === 'landing' && phase.landing_metrics">
                <span class="metric-label">Waitlist:</span>
                <span class="metric-value">{{ phase.landing_metrics.waitlist_signups || 0 }}</span>
              </div>
              
              <div class="metric-row" *ngIf="phase.moduleType === 'wizard'">
                <span class="metric-label">Completions:</span>
                <span class="metric-value">{{ phase.wizard_completions }}</span>
              </div>
              
              <div class="metric-row">
                <span class="metric-label">Sessions:</span>
                <span class="metric-value">{{ phase.totalSessions }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Concept Actions -->
      <div class="concept-actions mt-3">
        <button 
          class="btn btn-sm btn-outline-primary"
          (click)="viewDetails(getCurrentPhase(group.phases).moduleKey)">
          <i class="fas fa-chart-line me-1"></i>
          View Current Phase Details
        </button>
      </div>
    </div>
  </div>

</div>
