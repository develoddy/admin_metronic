<div class="container-fluid mt-4">
  <div class="card">
    <!-- Header -->
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="card-title mb-0"> Gesti贸n de Tenants</h4>
          <p class="text-muted mb-0">Total: {{ filteredTenants.length }} tenants</p>
        </div>
        <button class="btn btn-primary btn-sm" (click)="loadTenants()">
          <i class="fa fa-refresh" [ngClass]="{'fa-spin': isLoading}"></i>
          Actualizar
        </button>
      </div>
    </div>

    <div class="card-body">
      <!-- Filtros -->
      <div class="row mb-4">
        <div class="col-md-3">
          <label class="form-label"> Buscar</label>
          <input 
            type="text" 
            class="form-control" 
            placeholder="Nombre o email..."
            [(ngModel)]="filters.search"
            (ngModelChange)="onSearchChange()">
        </div>

        <div class="col-md-3">
          <label class="form-label"> Estado</label>
          <select class="form-select" [(ngModel)]="filters.status" (ngModelChange)="onFilterChange()">
            <option *ngFor="let status of statuses" [value]="status.value">
              {{ status.label }}
            </option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label"> M贸dulo</label>
          <select class="form-select" [(ngModel)]="filters.module" (ngModelChange)="onFilterChange()">
            <option *ngFor="let module of modules" [value]="module.value">
              {{ module.label }}
            </option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label"> Plan</label>
          <select class="form-select" [(ngModel)]="filters.plan" (ngModelChange)="onFilterChange()">
            <option *ngFor="let plan of plans" [value]="plan.value">
              {{ plan.label }}
            </option>
          </select>
        </div>

        <div class="col-md-1 d-flex align-items-end">
          <button class="btn btn-outline-secondary w-100" (click)="clearFilters()" title="Limpiar filtros">
            <i class="fa fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando tenants...</p>
      </div>

      <!-- Tabla -->
      <div *ngIf="!isLoading" class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th (click)="sortTable('name')" style="cursor: pointer;">
                Tenant
                <i class="fa fa-sort ms-1"></i>
              </th>
              <th (click)="sortTable('module_key')" style="cursor: pointer;">
                M贸dulo
                <i class="fa fa-sort ms-1"></i>
              </th>
              <th (click)="sortTable('plan')" style="cursor: pointer;">
                Plan
                <i class="fa fa-sort ms-1"></i>
              </th>
              <th (click)="sortTable('status')" style="cursor: pointer;">
                Estado
                <i class="fa fa-sort ms-1"></i>
              </th>
              <th (click)="sortTable('trial_ends_at')" style="cursor: pointer;">
                Trial / Renovaci贸n
                <i class="fa fa-sort ms-1"></i>
              </th>
              <th (click)="sortTable('created_at')" style="cursor: pointer;">
                Fecha Registro
                <i class="fa fa-sort ms-1"></i>
              </th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let tenant of paginatedTenants">
              <!-- Tenant Info -->
              <td>
                <div class="d-flex flex-column">
                  <strong>{{ tenant.name }}</strong>
                  <small class="text-muted">{{ tenant.email }}</small>
                </div>
              </td>

              <!-- M贸dulo -->
              <td>
                <span class="badge bg-info">{{ tenant.module_key }}</span>
              </td>

              <!-- Plan -->
              <td>
                <span class="badge bg-primary">{{ tenant.plan }}</span>
              </td>

              <!-- Estado -->
              <td>
                <span class="badge" [ngClass]="getStatusBadgeClass(tenant.status)">
                  {{ tenant.status }}
                </span>
                <div *ngIf="tenant.status === 'trial'" class="small text-muted mt-1">
                  {{ getDaysRemaining(tenant.trial_ends_at) }} d铆as restantes
                </div>
              </td>

              <!-- Trial/Renovaci贸n -->
              <td>
                <div *ngIf="tenant.status === 'trial'">
                  <small class="text-muted">Trial expira:</small>
                  <div>{{ formatDate(tenant.trial_ends_at) }}</div>
                </div>
                <div *ngIf="tenant.status === 'active' && tenant.subscribed_at">
                  <small class="text-muted">Suscrito:</small>
                  <div>{{ formatDate(tenant.subscribed_at) }}</div>
                </div>
                <div *ngIf="tenant.status === 'cancelled' && tenant.subscription_ends_at">
                  <small class="text-muted">Acceso hasta:</small>
                  <div>{{ formatDate(tenant.subscription_ends_at) }}</div>
                </div>
              </td>

              <!-- Fecha Registro -->
              <td>
                <small>{{ formatDate(tenant.created_at) }}</small>
              </td>

              <!-- Acciones -->
              <td class="text-end">
                <div class="dropdown d-inline-block" style="position: relative;">
                  <button 
                    class="btn btn-sm btn-light dropdown-toggle" 
                    (click)="toggleActions($event, tenant.id)">
                    Actions
                  </button>

                  <!-- Dropdown -->
                  <div 
                    *ngIf="openDropdownId === tenant.id"
                    class="dropdown-menu show shadow bg-white border rounded py-2"
                    style="position: absolute; left: 50%; transform: translateX(-76%); top: 100%; min-width: 180px; z-index: 1050;"
                    (click)="$event.stopPropagation()">
                    
                    <a class="dropdown-item" (click)="viewTenantDetails(tenant.id); closeDropdown()">
                      <i class="fa fa-eye me-2"></i>Ver Detalles
                    </a>
                    
                    <div *ngIf="tenant.status === 'trial'">
                      <div class="dropdown-divider"></div>
                      <a class="dropdown-item" (click)="extendTrial(tenant, 7); closeDropdown()">
                        <i class="fa fa-clock-o me-2"></i>Extender +7 d铆as
                      </a>
                      <a class="dropdown-item" (click)="extendTrial(tenant, 14); closeDropdown()">
                        <i class="fa fa-clock-o me-2"></i>Extender +14 d铆as
                      </a>
                      <a class="dropdown-item" (click)="extendTrial(tenant, 30); closeDropdown()">
                        <i class="fa fa-clock-o me-2"></i>Extender +30 d铆as
                      </a>
                    </div>

                    <div *ngIf="tenant.status === 'active'">
                      <div class="dropdown-divider"></div>
                      <a class="dropdown-item text-danger" (click)="cancelSubscription(tenant); closeDropdown()">
                        <i class="fa fa-times-circle me-2"></i>Cancelar Suscripci贸n
                      </a>
                    </div>

                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item text-warning" (click)="suspendTenant(tenant); closeDropdown()">
                      <i class="fa fa-ban me-2"></i>Suspender Cuenta
                    </a>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Sin resultados -->
        <div *ngIf="filteredTenants.length === 0" class="text-center py-5">
          <i class="fa fa-inbox fa-3x text-muted mb-3"></i>
          <p class="text-muted">No se encontraron tenants con los filtros seleccionados</p>
          <button class="btn btn-sm btn-outline-primary" (click)="clearFilters()">
            Limpiar filtros
          </button>
        </div>
      </div>

      <!-- Paginaci贸n -->
      <div *ngIf="!isLoading && filteredTenants.length > 0" class="d-flex justify-content-between align-items-center mt-4">
        <div class="text-muted">
          Mostrando {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, filteredTenants.length) }} de {{ filteredTenants.length }}
        </div>

        <nav aria-label="Paginaci贸n">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" [ngClass]="{'disabled': currentPage === 1}">
              <a class="page-link" (click)="changePage(currentPage - 1)">Anterior</a>
            </li>
            
            <li 
              *ngFor="let page of [].constructor(totalPages); let i = index" 
              class="page-item" 
              [ngClass]="{'active': currentPage === i + 1}">
              <a class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</a>
            </li>
            
            <li class="page-item" [ngClass]="{'disabled': currentPage === totalPages}">
              <a class="page-link" (click)="changePage(currentPage + 1)">Siguiente</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
