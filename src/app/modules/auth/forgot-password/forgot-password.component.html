<div class="login-form login-forgot">
  <!-- Success Message Section -->
  <ng-container *ngIf="emailSent && errorState === errorStates.NoError">
    <div class="card card-custom border-0 bg-light-success">
      <div class="card-body text-center py-15">
        <div class="mb-8">
          <i class="fas fa-envelope-open-text text-success" style="font-size: 4rem;"></i>
        </div>
        <h3 class="text-success font-weight-bolder mb-5">¡Email enviado correctamente!</h3>
        <p class="text-muted font-size-lg mb-8">
          Hemos enviado las instrucciones de recuperación a:<br>
          <strong class="text-dark">{{ f.email.value }}</strong>
        </p>
        <div class="d-flex flex-column flex-sm-row justify-content-center">
          <button
            type="button"
            class="btn btn-success font-weight-bolder px-8 py-4 mb-3 me-sm-3"
            (click)="goBackToLogin()"
          >
            <i class="fas fa-arrow-left me-2"></i>Volver al login
          </button>
          <button
            type="button"
            class="btn btn-light-success font-weight-bolder px-8 py-4 mb-3"
            (click)="resendEmail()"
          >
            <i class="fas fa-redo me-2"></i>Reenviar email
          </button>
        </div>
      </div>
    </div>
  </ng-container>

  <!--begin::Form-->
  <form
    *ngIf="!emailSent || errorState !== errorStates.NoError"
    class="form fv-plugins-bootstrap fv-plugins-framework"
    novalidate="novalidate"
    [formGroup]="forgotPasswordForm"
    (ngSubmit)="submit()"
    id="kt_login_forgot_form"
  >
    <!--begin::Title-->
    <div class="pb-13 pt-lg-0 pt-5">
      <div class="d-flex align-items-center mb-5">
        <i class="fas fa-key text-warning fs-2x me-3"></i>
        <div>
          <h3 class="font-weight-bolder text-dark font-size-h4 font-size-h1-lg mb-0">
            Recuperar Contraseña
          </h3>
          <span class="badge badge-light-warning fs-7 mt-1">
            <i class="fas fa-shield-alt me-1"></i>Proceso Seguro
          </span>
        </div>
      </div>
      <p class="text-muted font-weight-bold font-size-h6">
        Ingresa tu email para recibir instrucciones de recuperación
      </p>
    </div>
    <!--end::Title-->

    <!-- begin::Alert error-->
    <ng-container *ngIf="errorState === errorStates.HasError && errorMessage">
      <div class="mb-8 alert alert-custom alert-light-danger alert-dismissible border-0 rounded-lg animate__animated animate__shakeX">
        <div class="alert-text d-flex align-items-center">
          <i class="fas fa-exclamation-triangle fs-4 text-danger me-3"></i>
          <div>
            <strong>Error</strong><br>
            <small>{{ errorMessage }}</small>
          </div>
        </div>
      </div>
    </ng-container>
    <!-- end::Alert error-->

    <!-- begin::Alert loading-->
    <ng-container *ngIf="isLoading$ | async">
      <div class="mb-8 alert alert-custom alert-light-primary alert-dismissible border-0 rounded-lg">
        <div class="alert-text d-flex align-items-center">
          <div class="spinner-border spinner-border-sm text-primary me-3" role="status"></div>
          <div>
            <strong>Enviando solicitud...</strong><br>
            <small class="text-muted">Por favor espera un momento</small>
          </div>
        </div>
      </div>
    </ng-container>
    <!-- end::Alert loading-->

    <!--begin::Form group-->
    <div class="form-group fv-plugins-icon-container">
      <label class="font-size-h6 font-weight-bolder text-dark mb-3">
        <i class="fas fa-envelope text-muted me-2"></i>Correo electrónico
      </label>
      <input
        class="form-control form-control-solid h-auto py-7 px-6 rounded-lg font-size-h6"
        type="email"
        formControlName="email"
        placeholder="Ingresa tu email de administrador"
        name="email"
        autocomplete="email"
        [ngClass]="{
          'is-invalid': forgotPasswordForm.controls['email'].invalid && (forgotPasswordForm.controls['email'].dirty || forgotPasswordForm.controls['email'].touched)
        }"
      />

      <ng-container
        [ngTemplateOutlet]="formError"
        [ngTemplateOutletContext]="{
          validation: 'required',
          message: 'El email es requerido',
          control: forgotPasswordForm.controls['email']
        }"
      ></ng-container>
      <ng-container
        [ngTemplateOutlet]="formError"
        [ngTemplateOutletContext]="{
          validation: 'email',
          message: 'El formato del email es inválido',
          control: forgotPasswordForm.controls['email']
        }"
      ></ng-container>
      <ng-container
        [ngTemplateOutlet]="formError"
        [ngTemplateOutletContext]="{
          validation: 'minLength',
          message: 'El email debe tener al menos 3 caracteres',
          control: forgotPasswordForm.controls['email']
        }"
      ></ng-container>
      <ng-container
        [ngTemplateOutlet]="formError"
        [ngTemplateOutletContext]="{
          validation: 'maxLength',
          message: 'El email debe tener máximo 320 caracteres',
          control: forgotPasswordForm.controls['email']
        }"
      ></ng-container>
    </div>
    <!--end::Form group-->
    
    <!--begin::Form actions-->
    <div class="form-group d-flex flex-column pb-lg-0">
      <button
        type="submit"
        id="kt_login_forgot_submit"
        class="btn btn-primary w-100 font-weight-bolder font-size-h6 px-8 py-4 my-3 position-relative"
        [disabled]="forgotPasswordForm.invalid || (isLoading$ | async)"
      >
        <ng-container *ngIf="!(isLoading$ | async)">
          <i class="fas fa-paper-plane me-2"></i>Enviar instrucciones
        </ng-container>
        <ng-container *ngIf="isLoading$ | async">
          <span class="spinner-border spinner-border-sm me-2" role="status"></span>
          Enviando...
        </ng-container>
      </button>
      
      <div class="separator separator-content my-6">
        <span class="w-125px text-muted font-weight-bolder fs-7">¿Ya recordaste?</span>
      </div>
      
      <a
        routerLink="/auth/login"
        id="kt_login_forgot_cancel"
        class="btn btn-light-primary w-100 font-weight-bolder font-size-h6 px-8 py-4 text-decoration-none"
      >
        <i class="fas fa-arrow-left me-2"></i>Volver al login
      </a>
    </div>
    <!--end::Form actions-->
  </form>
  <!--end::Form-->
</div>

<ng-template
  #formError
  let-control="control"
  let-message="message"
  let-validation="validation"
>
  <ng-container
    *ngIf="control.hasError(validation) && (control.dirty || control.touched)"
  >
    <div class="fv-plugins-message-container">
      <div class="fv-help-block">
        {{ message }}
      </div>
    </div>
  </ng-container>
</ng-template>
