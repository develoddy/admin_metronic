<div class="card card-custom">
  <div class="card-header">
    <h3 class="card-title">
      <i class="fas fa-rocket text-danger mr-2"></i>
      Enviar Campa√±a de Lanzamiento
    </h3>
  </div>

  <div class="card-body">
    <!-- Warning Alert -->
    <div class="alert alert-warning d-flex align-items-center mb-5">
      <i class="fas fa-exclamation-triangle fa-2x mr-3 text-white"></i>
      <div>
        <strong>‚ö†Ô∏è Advertencia:</strong> Esta acci√≥n enviar√° emails masivos a todos los suscriptores verificados. 
        Aseg√∫rate de revisar la configuraci√≥n antes de enviar.
      </div>
    </div>

    <!-- Campaign Form -->
    <form [formGroup]="campaignForm">
      <div class="row">
        <!-- Coupon Configuration -->
        <div class="col-md-6">
          <div class="card card-custom bg-light">
            <div class="card-header">
              <h5 class="card-title">üéÅ Selecci√≥n de Cup√≥n</h5>
              <p class="text-muted mb-0 small">Selecciona un cup√≥n existente para la campa√±a</p>
            </div>
            <div class="card-body">
              <!-- Selector de cup√≥n -->
              <div class="form-group">
                <label>Cup√≥n Disponible <span class="text-danger">*</span></label>
                <select 
                  class="form-control" 
                  formControlName="selected_coupon_id"
                  (change)="onCouponSelect($event.target.value)"
                >
                  <option value="">-- Selecciona un cup√≥n --</option>
                  <option 
                    *ngFor="let coupon of availableCoupons" 
                    [value]="coupon.id"
                  >
                    {{ coupon.code }} - {{ coupon.type_discount === 'MONEDA' ? '‚Ç¨' + coupon.discount : coupon.discount + '%' }} 
                    ({{ coupon.type_coupon === 'DISCOUNT_PRODUCT' ? 'Por producto' : 'Total orden' }})
                  </option>
                </select>
                
                <!-- Loading state -->
                <div *ngIf="loadingCoupons" class="text-center mt-2">
                  <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="sr-only">Cargando cupones...</span>
                  </div>
                  <small class="text-muted ml-2">Cargando cupones disponibles...</small>
                </div>
                
                <!-- Empty state -->
                <div *ngIf="!loadingCoupons && availableCoupons.length === 0" class="alert alert-danger mt-2">
                  <i class="fas fa-info-circle mr-2"></i>
                  <strong>No hay cupones disponibles. </strong> 
                  <a routerLink="/cupones/register-cupon"  class="alert-link text-white text-decoration-underline">Crear un cup√≥n primero</a>
                </div>
                
                <small class="form-text text-muted">Solo se muestran cupones activos</small>
              </div>

              <!-- Informaci√≥n del cup√≥n seleccionado -->
              <div *ngIf="selectedCoupon" class="card border-primary mt-3">
                <div class="card-header bg-light-primary py-2">
                  <h6 class="mb-0 text-primary">
                    <i class="fas fa-ticket-alt mr-2"></i>Detalles del Cup√≥n
                  </h6>
                </div>
                <div class="card-body py-3">
                  <div class="row">
                    <div class="col-6">
                      <strong>C√≥digo:</strong>
                      <div class="form-group mt-1">
                        <input 
                          type="text" 
                          class="form-control form-control-sm" 
                          formControlName="coupon_code"
                          readonly
                        />
                      </div>
                    </div>
                    <div class="col-6">
                      <strong>Descuento:</strong>
                      <div class="form-group mt-1">
                        <input 
                          type="text" 
                          class="form-control form-control-sm" 
                          formControlName="coupon_discount"
                          readonly
                        />
                      </div>
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-6">
                      <strong>V√°lido por:</strong>
                      <div class="input-group input-group-sm mt-1">
                        <input 
                          type="number" 
                          class="form-control" 
                          formControlName="coupon_expiry_days"
                          readonly
                        />
                        <div class="input-group-append">
                          <span class="input-group-text">d√≠as</span>
                        </div>
                      </div>
                    </div>
                    <div class="col-6">
                      <strong>Tipo:</strong>
                      <div class="mt-1">
                        <span class="badge badge-info">
                          {{ selectedCoupon.type_coupon === 'DISCOUNT_PRODUCT' ? 'Por producto' : 'Total orden' }}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Informaci√≥n adicional -->
                  <div class="mt-2 p-2 bg-light-success rounded">
                    <small class="text-success">
                      <i class="fas fa-check-circle mr-1"></i>
                      Este cup√≥n ser√° enviado a todos los suscriptores de la campa√±a
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Products Configuration -->
        <div class="col-md-6">
          <div class="card card-custom bg-light">
            <div class="card-header">
              <h5 class="card-title">üõçÔ∏è Productos Destacados</h5>
              <p class="text-muted mb-0 small">Configura los productos que aparecer√°n en el email</p>
            </div>
            <div class="card-body">
              <div formArrayName="featured_products">
                <div *ngFor="let product of featuredProducts.controls; let i = index" class="mb-4">
                  <div [formGroupName]="i" class="card border-2 border-light-primary">
                    <div class="card-header bg-light-primary py-2">
                      <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-primary">
                          <i class="fas fa-box-open mr-2"></i>Producto {{ i + 1 }}
                        </h6>
                        <button 
                          type="button" 
                          class="btn btn-sm btn-light-danger" 
                          (click)="removeProduct(i)"
                          *ngIf="featuredProducts.length > 1"
                          title="Eliminar producto"
                        >
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                    
                    <div class="card-body">
                      <div class="row">
                        <!-- Preview de imagen -->
                        <div class="col-4">
                          <div class="text-center mb-2">
                            <div class="product-preview-container position-relative">
                              <img 
                                *ngIf="product.get('image')?.value && product.get('image')?.value.length > 0"
                                [src]="product.get('image')?.value" 
                                class="img-fluid rounded border"
                                style="max-height: 80px; width: auto;"
                                (error)="$event.target.src='assets/media/icons/placeholder-image.svg'"
                                [title]="product.get('name')?.value || 'Producto'"
                              />
                              <div 
                                *ngIf="!product.get('image')?.value || product.get('image')?.value.length === 0"
                                class="d-flex align-items-center justify-content-center bg-light border rounded"
                                style="height: 80px; min-width: 80px;"
                              >
                                <i class="fas fa-image text-muted fa-2x"></i>
                              </div>
                            </div>
                            <small class="text-muted d-block mt-1">Preview</small>
                          </div>
                        </div>
                        
                        <!-- Campos de entrada -->
                        <div class="col-8">
                          <div class="form-group mb-2">
                            <label class="form-label text-dark font-weight-bold small">Nombre</label>
                            <input 
                              type="text" 
                              class="form-control form-control-sm" 
                              formControlName="name"
                              placeholder="Ej: Camiseta Premium Developer"
                            />
                          </div>
                          
                          <div class="form-group mb-2">
                            <label class="form-label text-dark font-weight-bold small">Precio</label>
                            <input 
                              type="text" 
                              class="form-control form-control-sm" 
                              formControlName="price"
                              placeholder="Ej: ‚Ç¨24.95"
                            />
                          </div>
                          
                          <div class="form-group mb-0">
                            <label class="form-label text-dark font-weight-bold small">URL de Imagen</label>
                            <div class="input-group input-group-sm">
                              <input 
                                type="text" 
                                class="form-control form-control-sm" 
                                formControlName="image"
                                placeholder="URL completa de la imagen del producto"
                              />
                              <div class="input-group-append">
                                <span class="input-group-text">
                                  <i class="fas fa-link" 
                                     [class.text-success]="product.get('image')?.value && product.get('image')?.value.length > 10"
                                     [class.text-muted]="!product.get('image')?.value || product.get('image')?.value.length <= 10">
                                  </i>
                                </span>
                              </div>
                            </div>
                            <small class="text-muted">La imagen se mostrar√° en el email de la campa√±a</small>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Informaci√≥n adicional del producto -->
                      <div class="mt-2 p-2 bg-light-info rounded" *ngIf="product.get('name')?.value && product.get('price')?.value">
                        <small class="text-info">
                          <i class="fas fa-info-circle mr-1"></i>
                          <strong>{{ product.get('name')?.value }}</strong> - {{ product.get('price')?.value }}
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Bot√≥n agregar producto -->
              <div class="text-center mt-3">
                <button 
                  type="button" 
                  class="btn btn-light-primary btn-sm" 
                  (click)="addProduct()"
                  *ngIf="featuredProducts.length < 6"
                >
                  <i class="fas fa-plus mr-2"></i> Agregar Producto
                </button>
                
                <!-- Informaci√≥n sobre l√≠mites -->
                <div class="mt-2" *ngIf="featuredProducts.length >= 4">
                  <small class="text-muted">
                    <i class="fas fa-info-circle mr-1"></i>
                    {{ featuredProducts.length }}/6 productos configurados
                    <span *ngIf="featuredProducts.length >= 6" class="text-warning">
                      - L√≠mite alcanzado
                    </span>
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="row mt-5">
        <div class="col-12">
          <div class="d-flex justify-content-between">
            <div>
              <button 
                type="button" 
                class="btn btn-light-primary btn-lg"
                (click)="previewEmail()"
                [disabled]="campaignForm.invalid || previewLoading"
              >
                <i class="fas fa-eye mr-2"></i>
                {{ previewLoading ? 'Generando...' : 'Vista Previa' }}
              </button>
            </div>

            <div>
              <button 
                type="button" 
                class="btn btn-danger btn-lg"
                (click)="launchCampaign()"
                [disabled]="campaignForm.invalid || sending"
              >
                <i class="fas fa-rocket mr-2"></i>
                <span *ngIf="!sending">Enviar Campa√±a</span>
                <span *ngIf="sending">
                  <span class="spinner-border spinner-border-sm mr-2"></span>
                  Enviando... {{ sendingProgress }}%
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!-- Result Display -->
    <div *ngIf="result" class="mt-5">
      <div class="alert" [ngClass]="{
        'alert-success': result.success,
        'alert-danger': !result.success
      }">
        <h5>
          <i [ngClass]="{
            'fas fa-check-circle': result.success,
            'fas fa-times-circle': !result.success
          }"></i>
          {{ result.success ? '¬°Campa√±a Enviada Exitosamente!' : 'Error en la Campa√±a' }}
        </h5>
        <div class="mt-3">
          <strong>Estad√≠sticas:</strong>
          <ul class="mb-0 mt-2">
            <li>Emails enviados: <strong>{{ result.sent }}</strong></li>
            <li>Errores: <strong>{{ result.errors }}</strong></li>
            <li>Total procesados: <strong>{{ result.total }}</strong></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Email Preview Modal -->
<div *ngIf="showPreview">
  <div class="modal-backdrop fade show" (click)="closePreview()"></div>
  <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-envelope mr-2"></i>
          Vista Previa del Email
        </h5>
        <button type="button" class="close" (click)="closePreview()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div *ngIf="emailPreview" [innerHTML]="emailPreview" class="email-preview-container"></div>
        <div *ngIf="!emailPreview" class="text-center py-5">
          <div class="spinner-border text-primary"></div>
          <p class="mt-3">Generando preview...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closePreview()">Cerrar</button>
        <button type="button" class="btn btn-danger" (click)="launchCampaign()">
          <i class="fas fa-rocket mr-2"></i> Enviar Campa√±a
        </button>
      </div>
    </div>
  </div>
  </div>
</div>
