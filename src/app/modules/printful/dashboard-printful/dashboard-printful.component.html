<!-- Dashboard Header -->
<div class="d-flex flex-wrap flex-stack mb-6">
  <h3 class="fw-bolder my-2">
    Dashboard Printful
    <span class="fs-6 text-gray-400 fw-bold ms-1">Inventario y Estad√≠sticas</span>
  </h3>
  <div class="d-flex align-items-center my-2">
    <button class="btn btn-sm btn-light-secondary text-dark me-3" routerLink="/printful/email-testing">
      <i class="fa fa-envelope fs-4 me-2 text-dark "></i>
      üß™ Testing Email
    </button>
    <button class="btn btn-sm btn-light-primary me-3" (click)="refreshDashboard()">
      <i class="fa fa-sync-alt fs-4 me-2"></i>
      Actualizar
    </button>
    <button class="btn btn-sm btn-primary" (click)="syncCatalog()">
      <i class="fa fa-cloud-download-alt fs-4 me-2"></i>
      Sincronizar con Printful
    </button>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="loading" class="text-center py-10">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Cargando...</span>
  </div>
  <p class="text-gray-600 mt-3">Cargando estad√≠sticas...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="alert alert-danger d-flex align-items-center">
  <i class="fa fa-exclamation-circle fs-2 me-3"></i>
  <div>
    <strong>Error al cargar el dashboard</strong>
    <p class="mb-0">No se pudieron obtener las estad√≠sticas. Intenta recargar la p√°gina.</p>
  </div>
</div>

<!-- Dashboard Content -->
<div *ngIf="!loading && !error">
  
  <!-- SECCI√ìN FINANCIERA -->
  <div *ngIf="financialStats" class="mb-10">
    <h2 class="text-dark fw-bolder mb-5">üí∞ Analytics Financieros</h2>
    
    <!-- Financial KPIs -->
    <div class="row g-5 g-xl-8 mb-8">
      <!-- Total Revenue -->
      <div class="col-xl-3">
        <div class="card card-flush h-100 bg-light-success">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <span class="text-gray-700 fw-bold fs-6">üíµ Ingresos Totales</span>
              <i class="bi bi-cash-coin fs-2x text-success"></i>
            </div>
            <span class="fw-bolder fs-2hx text-success d-block">
              {{ formatCurrency(financialStats.totalRevenue) }}
            </span>
            <span class="text-gray-600 fw-semibold fs-7 d-block mt-2">
              {{ financialStats.totalOrders }} √≥rdenes
            </span>
          </div>
        </div>
      </div>
      
      <!-- Total Cost -->
      <div class="col-xl-3">
        <div class="card card-flush h-100 bg-light-danger">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <span class="text-gray-700 fw-bold fs-6">üè≠ Costes Printful</span>
              <i class="bi bi-coin fs-2x text-danger"></i>
            </div>
            <span class="fw-bolder fs-2hx text-danger d-block">
              {{ formatCurrency(financialStats.totalCost) }}
            </span>
            <span class="text-gray-600 fw-semibold fs-7 d-block mt-2">
              Costes de producci√≥n
            </span>
          </div>
        </div>
      </div>
      
      <!-- Total Profit -->
      <div class="col-xl-3">
        <div class="card card-flush h-100" [ngClass]="financialStats.totalProfit >= 0 ? 'bg-light-primary' : 'bg-light-warning'">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <span class="text-gray-700 fw-bold fs-6">üìä Beneficio Neto</span>
              <i class="bi bi-graph-up-arrow fs-2x" [ngClass]="financialStats.totalProfit >= 0 ? 'text-primary' : 'text-warning'"></i>
            </div>
            <span class="fw-bolder fs-2hx d-block" [ngClass]="financialStats.totalProfit >= 0 ? 'text-primary' : 'text-warning'">
              {{ formatCurrency(financialStats.totalProfit) }}
            </span>
            <span class="text-gray-600 fw-semibold fs-7 d-block mt-2">
              {{ financialStats.averageMargin }}% margen
            </span>
          </div>
        </div>
      </div>
      
      <!-- Average Margin -->
      <div class="col-xl-3">
        <div class="card card-flush h-100 bg-light-info">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <span class="text-gray-700 fw-bold fs-6">üìà Margen Promedio</span>
              <i class="bi bi-percent fs-2x text-info"></i>
            </div>
            <span class="fw-bolder fs-2hx text-info d-block">
              {{ financialStats.averageMargin }}%
            </span>
            <span class="text-gray-600 fw-semibold fs-7 d-block mt-2">
              De rentabilidad
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Revenue Chart -->
    <div class="card card-flush mb-8" *ngIf="timelineData && timelineData.length > 0">
      <div class="card-header">
        <h3 class="card-title">üìà Ingresos vs Costes (√öltimos 30 d√≠as)</h3>
      </div>
      <div class="card-body">
        <apx-chart
          *ngIf="revenueChartOptions"
          [series]="revenueChartOptions.series"
          [chart]="revenueChartOptions.chart"
          [xaxis]="revenueChartOptions.xaxis"
          [yaxis]="revenueChartOptions.yaxis"
          [dataLabels]="revenueChartOptions.dataLabels"
          [stroke]="revenueChartOptions.stroke"
          [tooltip]="revenueChartOptions.tooltip"
          [grid]="revenueChartOptions.grid"
          [legend]="revenueChartOptions.legend">
        </apx-chart>
      </div>
    </div>
    
    <!-- Products Ranking -->
    <div class="row g-5 mb-8">
      <!-- Top Profitable Products -->
      <div class="col-xl-6">
        <div class="card card-flush h-100">
          <div class="card-header">
            <h3 class="card-title">üèÜ Top 5 Productos Rentables</h3>
          </div>
          <div class="card-body pt-2">
            <div *ngIf="topProfitableProducts.length === 0" class="text-center py-10 text-gray-500">
              No hay datos disponibles
            </div>
            <div *ngFor="let product of topProfitableProducts; let i = index" class="d-flex align-items-center mb-5">
              <div class="symbol symbol-50px me-3">
                <img [src]="product.image" [alt]="product.name" class="w-100">
              </div>
              <div class="flex-grow-1">
                <span class="text-dark fw-bold d-block">{{ product.name }}</span>
                <span class="text-muted fs-7">{{ product.totalQuantity }} unidades vendidas</span>
              </div>
              <div class="text-end">
                <span class="text-success fw-bold d-block">{{ formatCurrency(product.totalProfit) }}</span>
                <span class="badge badge-light-success">{{ product.averageMargin }}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Top Losing Products -->
      <div class="col-xl-6">
        <div class="card card-flush h-100">
          <div class="card-header">
            <h3 class="card-title">‚ö†Ô∏è Productos con P√©rdidas</h3>
          </div>
          <div class="card-body pt-2">
            <div *ngIf="topLosingProducts.length === 0" class="text-center py-10 text-gray-500">
              ‚úÖ No hay productos con p√©rdidas
            </div>
            <div *ngFor="let product of topLosingProducts; let i = index" class="d-flex align-items-center mb-5">
              <div class="symbol symbol-50px me-3">
                <img [src]="product.image" [alt]="product.name" class="w-100">
              </div>
              <div class="flex-grow-1">
                <span class="text-dark fw-bold d-block">{{ product.name }}</span>
                <span class="text-muted fs-7">{{ product.totalQuantity }} unidades vendidas</span>
              </div>
              <div class="text-end">
                <span class="text-danger fw-bold d-block">{{ formatCurrency(product.totalProfit) }}</span>
                <span class="badge badge-light-danger">{{ product.averageMargin }}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN ALERTAS DE STOCK -->
  <div class="mb-10">
    <div class="row g-5">
      <div class="col-xl-4">
        <app-stock-alerts-printful></app-stock-alerts-printful>
      </div>
      <div class="col-xl-8">
        <!-- Placeholder para futuros widgets o gr√°ficos -->
      </div>
    </div>
  </div>
  
  <!-- SECCI√ìN INVENTARIO -->
  <h2 class="text-dark fw-bolder mb-5">üè≠ Inventario de Productos</h2>
  
  <!-- KPI Cards Row -->
  <div class="row g-5 g-xl-8 mb-8">
    <!-- Total Products -->
    <div class="col-xl-3">
      <div class="card card-flush h-100">
        <div class="card-body d-flex flex-column justify-content-between">
          <div class="d-flex flex-stack mb-5">
            <span class="text-gray-400 fw-bold fs-6">Total Productos</span>
            <i class="fa fa-box fs-2x text-primary"></i>
          </div>
          <div class="d-flex flex-column">
            <span class="fw-bolder fs-2x text-dark">{{ stats.totalProducts }}</span>
            <span class="text-muted fw-bold fs-7 mt-1">
              {{ stats.activeProducts }} activos / {{ stats.inactiveProducts }} inactivos
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Total Variants -->
    <div class="col-xl-3">
      <div class="card card-flush h-100">
        <div class="card-body d-flex flex-column justify-content-between">
          <div class="d-flex flex-stack mb-5">
            <span class="text-gray-400 fw-bold fs-6">Total Variantes</span>
            <i class="fa fa-th fs-2x text-success"></i>
          </div>
          <div class="d-flex flex-column">
            <span class="fw-bolder fs-2x text-dark">{{ stats.totalVariants }}</span>
            <span class="text-muted fw-bold fs-7 mt-1">
              Tallas y colores disponibles
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Inventory Value -->
    <div class="col-xl-3">
      <div class="card card-flush h-100">
        <div class="card-body d-flex flex-column justify-content-between">
          <div class="d-flex flex-stack mb-5">
            <span class="text-gray-400 fw-bold fs-6">Valor Inventario</span>
            <i class="fa fa-euro-sign fs-2x text-warning"></i>
          </div>
          <div class="d-flex flex-column">
            <span class="fw-bolder fs-2x text-dark">{{ formatCurrency(stats.totalInventoryValue) }}</span>
            <span class="text-muted fw-bold fs-7 mt-1">
              Precio promedio: {{ formatCurrency(stats.averagePrice) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Categories -->
    <div class="col-xl-3">
      <div class="card card-flush h-100">
        <div class="card-body d-flex flex-column justify-content-between">
          <div class="d-flex flex-stack mb-5">
            <span class="text-gray-400 fw-bold fs-6">Categor√≠as</span>
            <i class="fa fa-folder fs-2x text-info"></i>
          </div>
          <div class="d-flex flex-column">
            <span class="fw-bolder fs-2x text-dark">{{ stats.totalCategories }}</span>
            <span class="text-muted fw-bold fs-7 mt-1">
              √öltima sincronizaci√≥n: {{ formatDate(stats.lastSync) }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row g-5 g-xl-8 mb-8">
    <!-- Category Distribution Chart -->
    <div class="col-xl-6">
      <div class="card card-flush h-100">
        <div class="card-header pt-5">
          <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bolder text-dark">Distribuci√≥n por Categor√≠a</span>
            <span class="text-muted mt-1 fw-bold fs-7">Productos por categor√≠a</span>
          </h3>
        </div>
        <div class="card-body pt-0">
          <div id="category-chart" *ngIf="stats.categoriesDistribution.length > 0">
            <apx-chart
              [series]="categoryChartOptions.series"
              [chart]="categoryChartOptions.chart"
              [plotOptions]="categoryChartOptions.plotOptions"
              [dataLabels]="categoryChartOptions.dataLabels"
              [xaxis]="categoryChartOptions.xaxis"
              [colors]="categoryChartOptions.colors"
              [title]="categoryChartOptions.title"
            ></apx-chart>
          </div>
          <div *ngIf="stats.categoriesDistribution.length === 0" class="text-center py-10">
            <i class="fa fa-chart-bar fs-3x text-gray-400"></i>
            <p class="text-gray-600 mt-3">No hay datos disponibles</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Distribution Chart -->
    <div class="col-xl-6">
      <div class="card card-flush h-100">
        <div class="card-header pt-5">
          <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bolder text-dark">Estado del Cat√°logo</span>
            <span class="text-muted mt-1 fw-bold fs-7">Productos activos vs inactivos</span>
          </h3>
        </div>
        <div class="card-body pt-0">
          <div id="status-chart" *ngIf="stats.totalProducts > 0">
            <apx-chart
              [series]="statusChartOptions.series"
              [chart]="statusChartOptions.chart"
              [labels]="statusChartOptions.labels"
              [colors]="statusChartOptions.colors"
              [legend]="statusChartOptions.legend"
              [title]="statusChartOptions.title"
            ></apx-chart>
          </div>
          <div *ngIf="stats.totalProducts === 0" class="text-center py-10">
            <i class="fa fa-chart-pie fs-3x text-gray-400"></i>
            <p class="text-gray-600 mt-3">No hay datos disponibles</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Price Analysis & Alerts Row -->
  <div class="row g-5 g-xl-8 mb-8">
    <!-- Price Analysis -->
    <div class="col-xl-4">
      <div class="card card-flush h-100">
        <div class="card-header pt-5">
          <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bolder text-dark">An√°lisis de Precios</span>
            <span class="text-muted mt-1 fw-bold fs-7">Rango y promedios</span>
          </h3>
        </div>
        <div class="card-body pt-3">
          <div class="d-flex flex-column mb-5">
            <div class="d-flex justify-content-between mb-3">
              <span class="text-gray-600 fw-bold">Precio M√≠nimo:</span>
              <span class="fw-bolder text-dark">{{ formatCurrency(stats.priceRange.min) }}</span>
            </div>
            <div class="d-flex justify-content-between mb-3">
              <span class="text-gray-600 fw-bold">Precio M√°ximo:</span>
              <span class="fw-bolder text-dark">{{ formatCurrency(stats.priceRange.max) }}</span>
            </div>
            <div class="d-flex justify-content-between mb-3">
              <span class="text-gray-600 fw-bold">Precio Promedio:</span>
              <span class="fw-bolder text-primary">{{ formatCurrency(stats.averagePrice) }}</span>
            </div>
          </div>

          <!-- Top Expensive Products -->
          <div class="mb-5" *ngIf="stats.topExpensive.length > 0">
            <h5 class="text-gray-700 fw-bold mb-3">M√°s Caros</h5>
            <div *ngFor="let product of stats.topExpensive" class="d-flex align-items-center mb-3">
              <div class="symbol symbol-35px me-3">
                <img [src]="getProductImage(product.imagen)" [alt]="product.title" style="object-fit: cover; width: 35px; height: 35px; border-radius: 4px;">
              </div>
              <div class="flex-grow-1">
                <span class="text-gray-800 fw-bold d-block fs-7">{{ product.title }}</span>
                <span class="text-muted fw-bold fs-8">{{ formatCurrency(product.price_usd) }}</span>
              </div>
            </div>
          </div>

          <!-- Top Cheap Products -->
          <div *ngIf="stats.topCheap.length > 0">
            <h5 class="text-gray-700 fw-bold mb-3">M√°s Baratos</h5>
            <div *ngFor="let product of stats.topCheap" class="d-flex align-items-center mb-3">
              <div class="symbol symbol-35px me-3">
                <img [src]="getProductImage(product.imagen)" [alt]="product.title" style="object-fit: cover; width: 35px; height: 35px; border-radius: 4px;">
              </div>
              <div class="flex-grow-1">
                <span class="text-gray-800 fw-bold d-block fs-7">{{ product.title }}</span>
                <span class="text-muted fw-bold fs-8">{{ formatCurrency(product.price_usd) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerts Panel -->
    <div class="col-xl-8">
      <div class="card card-flush h-100">
        <div class="card-header pt-5">
          <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bolder text-dark">Alertas del Sistema</span>
            <span class="text-muted mt-1 fw-bold fs-7">Problemas detectados</span>
          </h3>
        </div>
        <div class="card-body pt-3">
          <div *ngIf="stats.alerts.length === 0" class="text-center py-10">
            <i class="fa fa-check-circle fs-3x text-success"></i>
            <p class="text-gray-600 mt-3 fw-bold">¬°Todo en orden! No hay alertas</p>
          </div>

          <div *ngFor="let alert of stats.alerts" class="alert alert-{{ getAlertClass(alert.type) }} d-flex align-items-center mb-5">
            <i class="fa {{ getAlertIcon(alert.type) }} fs-2 me-4"></i>
            <div class="flex-grow-1">
              <div class="fw-bold">{{ alert.message }}</div>
              <div class="text-muted fs-7 mt-1">{{ alert.count }} producto(s) afectado(s)</div>
            </div>
            <a [routerLink]="['/printful/products']" [queryParams]="getAlertQueryParams(alert.type)" class="btn btn-sm btn-light-{{ getAlertClass(alert.type) }}">
              Ver Productos
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row g-5 g-xl-8">
    <div class="col-xl-12">
      <div class="card card-flush">
        <div class="card-header pt-5">
          <h3 class="card-title align-items-start flex-column">
            <span class="card-label fw-bolder text-dark">Acciones R√°pidas</span>
            <span class="text-muted mt-1 fw-bold fs-7">Gesti√≥n del cat√°logo</span>
          </h3>
        </div>
        <div class="card-body pt-5">
          <div class="d-flex flex-wrap gap-3">
            <a routerLink="/printful/products" class="btn btn-light-primary">
              <i class="fa fa-box fs-4 me-2"></i>
              Ver Todos los Productos
            </a>
            <button class="btn btn-light-success" (click)="syncCatalog()">
              <i class="fa fa-sync-alt fs-4 me-2"></i>
              Sincronizar Cat√°logo
            </button>
            <a routerLink="/printful/products" [queryParams]="{ state: '2' }" class="btn btn-light-info">
              <i class="fa fa-eye fs-4 me-2"></i>
              Ver Activos
            </a>
            <a routerLink="/printful/products" [queryParams]="{ state: '1' }" class="btn btn-light-warning">
              <i class="fa fa-eye-slash fs-4 me-2"></i>
              Ver Inactivos
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div *ngIf="showToast" class="toast show align-items-center text-white bg-{{ toastType === 'success' ? 'success' : toastType === 'error' ? 'danger' : toastType === 'warning' ? 'warning' : 'info' }} border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body d-flex align-items-center">
        <i class="fa {{ toastType === 'success' ? 'fa-check-circle' : toastType === 'error' ? 'fa-times-circle' : toastType === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle' }} fs-3 me-3"></i>
        {{ toastMessage }}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="closeToast()"></button>
    </div>
  </div>
</div>
