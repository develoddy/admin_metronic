<div class="row">
  <div class="col-xl-12">
    <!-- Header -->
    <div class="card card-custom gutter-b">
      <div class="card-body d-flex align-items-center justify-content-between flex-wrap">
        <div class="mr-2">
          <h3 class="font-weight-bolder mb-0">ðŸ“¹ Mis Video Jobs</h3>
          <div class="text-muted font-size-sm mt-2">
            Gestiona todos tus videos generados con IA
          </div>
        </div>
        <div>
          <button 
            class="btn btn-primary font-weight-bolder"
            (click)="createNewVideo()">
            <i class="flaticon2-plus"></i>
            Crear Video
          </button>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card card-custom gutter-b">
      <div class="card-body py-3">
        <div class="d-flex align-items-center justify-content-between flex-wrap">
          <div class="mr-3 mb-2">
            <label class="text-muted font-weight-bold mr-3">Filtrar por estado:</label>
            <div class="btn-group" role="group">
              <button 
                type="button" 
                class="btn btn-sm"
                [class.btn-primary]="statusFilter === 'all'"
                [class.btn-light-primary]="statusFilter !== 'all'"
                (click)="filterByStatus('all')">
                Todos ({{ jobs.length }})
              </button>
              <button 
                type="button" 
                class="btn btn-sm"
                [class.btn-warning]="statusFilter === 'processing'"
                [class.btn-light-warning]="statusFilter !== 'processing'"
                (click)="filterByStatus('processing')">
                Procesando ({{ getJobCountByStatus('processing') + getJobCountByStatus('pending') }})
              </button>
              <button 
                type="button" 
                class="btn btn-sm"
                [class.btn-success]="statusFilter === 'completed'"
                [class.btn-light-success]="statusFilter !== 'completed'"
                (click)="filterByStatus('completed')">
                Completados ({{ getJobCountByStatus('completed') }})
              </button>
              <button 
                type="button" 
                class="btn btn-sm"
                [class.btn-danger]="statusFilter === 'failed'"
                [class.btn-light-danger]="statusFilter !== 'failed'"
                (click)="filterByStatus('failed')">
                Fallidos ({{ getJobCountByStatus('failed') }})
              </button>
            </div>
          </div>

          <!-- Auto-refresh indicator -->
          <div *ngIf="hasActiveJobs()" class="text-muted font-size-sm">
            <i class="flaticon2-reload icon-sm text-warning"></i>
            Auto-actualizaciÃ³n cada 10 seg
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="text-center py-10">
      <div class="spinner spinner-primary spinner-lg"></div>
      <p class="text-muted mt-3">Cargando jobs...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="alert alert-danger" role="alert">
      <strong>Error:</strong> {{ error }}
      <button class="btn btn-sm btn-light ml-3" (click)="loadJobs()">Reintentar</button>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && !error && jobs.length === 0" class="card card-custom">
      <div class="card-body text-center py-20">
        <div class="mb-10">
          <i class="flaticon2-photo-camera icon-5x text-muted"></i>
        </div>
        <h3 class="font-weight-bolder mb-3">No hay jobs</h3>
        <p class="text-muted mb-5">
          {{ statusFilter === 'all' 
             ? 'AÃºn no has creado ningÃºn video' 
             : 'No hay jobs con el estado seleccionado' }}
        </p>
        <button class="btn btn-primary" (click)="createNewVideo()">
          Crear tu Primer Video
        </button>
      </div>
    </div>

    <!-- Jobs Table -->
    <div *ngIf="!loading && !error && jobs.length > 0" class="card card-custom">
      <div class="card-body pt-0 pb-3">
        <div class="table-responsive">
          <table class="table table-head-custom table-vertical-center table-hover">
            <thead>
              <tr>
                <th class="pl-0 text-center" style="width: 80px;">Imagen</th>
                <th style="min-width: 150px;">Job ID</th>
                <th>Estilo</th>
                <th>Estado</th>
                <th>Creado</th>
                <th>Completado</th>
                <th class="text-right pr-0" style="min-width: 150px;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let job of jobs">
                <!-- Image -->
                <td class="pl-0 text-center">
                  <div class="symbol symbol-50 symbol-light-primary">
                    <img 
                      [src]="job.product_image_url" 
                      alt="Product" 
                      class="img-fluid rounded"
                      style="object-fit: cover; width: 50px; height: 50px;">
                  </div>
                </td>

                <!-- Job ID -->
                <td>
                  <span 
                    class="text-dark-75 font-weight-bold d-block font-size-sm text-truncate"
                    style="max-width: 150px;"
                    [title]="job.id">
                    {{ job.id.substring(0, 8) }}...
                  </span>
                </td>

                <!-- Animation Style -->
                <td>
                  <span class="text-dark-75 font-weight-bolder d-block font-size-sm">
                    {{ animationLabels[job.animation_style] }}
                  </span>
                </td>

                <!-- Status -->
                <td>
                  <span [class]="'badge badge-pill ' + statusClasses[job.status]">
                    {{ statusLabels[job.status] }}
                  </span>
                  <!-- Progress indicator for processing jobs -->
                  <div *ngIf="job.status === 'processing' || job.status === 'pending'" class="mt-1">
                    <div class="progress" style="height: 4px;">
                      <div 
                        class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                        role="progressbar" 
                        style="width: 100%">
                      </div>
                    </div>
                  </div>
                </td>

                <!-- Created At -->
                <td>
                  <span class="text-muted font-weight-bold">
                    {{ job.created_at | date: 'short' }}
                  </span>
                </td>

                <!-- Completed At -->
                <td>
                  <span class="text-muted font-weight-bold">
                    {{ job.completed_at ? (job.completed_at | date: 'short') : '-' }}
                  </span>
                </td>

                <!-- Actions -->
                <td class="text-right pr-0">
                  <button 
                    class="btn btn-sm btn-light-primary btn-icon mr-2"
                    (click)="viewJob(job)"
                    title="Ver detalles">
                    <i class="flaticon-eye"></i>
                  </button>
                  
                  <button 
                    *ngIf="job.status === 'completed'"
                    class="btn btn-sm btn-light-success btn-icon mr-2"
                    (click)="downloadVideo(job)"
                    title="Descargar video">
                    <i class="flaticon2-download"></i>
                  </button>

                  <button 
                    class="btn btn-sm btn-light-danger btn-icon"
                    (click)="deleteJob(job)"
                    title="Eliminar">
                    <i class="flaticon2-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
