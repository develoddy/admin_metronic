<div class="customer-context-panel">
  
  <div class="panel-content" *ngIf="context">
    
    <!-- Header enterprise -->
    <div class="panel-header">
      <div class="header-top">
        <h5 class="panel-title">Informaci√≥n del Cliente</h5>
        <span class="type-badge" [class.is-user]="context.type === 'user'" [class.is-guest]="context.type === 'guest'">
          <i class="fas" [class.fa-user]="context.type === 'user'" [class.fa-user-secret]="context.type === 'guest'"></i>
          {{ context.type === 'user' ? 'Registrado' : 'Invitado' }}
        </span>
      </div>
      <p class="client-identifier">{{ context.identifier }}</p>
    </div>

    <!-- Tabs Navigation enterprise -->
    <ul class="nav nav-tabs nav-tabs-enterprise">
      <li class="nav-item">
        <button class="nav-link" [class.active]="isActive('overview')" (click)="setActiveTab('overview')" title="Informaci√≥n general">
          <i class="fas fa-info-circle"></i>
          <span>Cliente</span>
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" [class.active]="isActive('orders')" (click)="setActiveTab('orders')" title="Historial de pedidos">
          <i class="fas fa-shopping-bag"></i>
          <span>Pedidos</span>
          <span class="count-badge" *ngIf="context.activeOrders.length > 0">{{ context.activeOrders.length }}</span>
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" [class.active]="isActive('assistant')" (click)="setActiveTab('assistant')" title="Asistente IA">
          <i class="fas fa-robot"></i>
          <span>IA</span>
          <span class="active-indicator" *ngIf="hasActiveIntent()"></span>
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" [class.active]="isActive('returns')" (click)="setActiveTab('returns')" title="Gesti√≥n de devoluciones">
          <i class="fas fa-undo-alt"></i>
          <span>Acciones</span>
          <span class="count-badge" *ngIf="context.returns.length > 0">{{ context.returns.length }}</span>
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      
      <!-- OVERVIEW TAB -->
      <div class="tab-pane" *ngIf="activeTab === 'overview' && context" style="display: block;">
        <section class="info-section">
          <h6 class="section-title">
            <i class="fas fa-user-circle"></i>
            Datos del Cliente
          </h6>
          <div class="info-row" *ngIf="context.name || context.surname">
            <span class="label"><i class="fas fa-user"></i> Nombre:</span>
            <span class="value">{{ (context.name || '') + (context.surname ? ' ' + context.surname : '') || 'N/A' }}</span>
          </div>
          <div class="info-row">
            <span class="label"><i class="fas fa-envelope"></i> Email:</span>
            <span class="value">{{ context.email || context.identifier || 'N/A' }}</span>
          </div>
          <div class="info-row">
            <span class="label"><i class="fas fa-id-badge"></i> Tipo:</span>
            <span class="value">{{ context.type === 'user' ? 'Usuario registrado' : 'Invitado' }}</span>
          </div>
          <div class="info-row" *ngIf="context.phone">
            <span class="label"><i class="fas fa-phone"></i> Tel√©fono:</span>
            <span class="value">{{ context.phone }}</span>
          </div>
        </section>

        <!-- Secci√≥n de direcci√≥n (solo si hay datos) -->
        <section class="info-section mt-3" *ngIf="context.address || context.city || context.zipcode || context.country">
          <h6 class="section-title">
            <i class="fas fa-map-marker-alt"></i>
            Direcci√≥n
          </h6>
          <div class="info-row" *ngIf="context.address">
            <span class="label"><i class="fas fa-home"></i> Direcci√≥n:</span>
            <span class="value">{{ context.address }}</span>
          </div>
          <div class="info-row" *ngIf="context.city">
            <span class="label"><i class="fas fa-city"></i> Ciudad:</span>
            <span class="value">{{ context.city }}</span>
          </div>
          <div class="info-row" *ngIf="context.zipcode">
            <span class="label"><i class="fas fa-mail-bulk"></i> C√≥digo Postal:</span>
            <span class="value">{{ context.zipcode }}</span>
          </div>
          <div class="info-row" *ngIf="context.country">
            <span class="label"><i class="fas fa-flag"></i> Pa√≠s:</span>
            <span class="value">{{ context.country }}</span>
          </div>
        </section>

        <section class="info-section mt-3">
          <h6 class="section-title">
            <i class="fas fa-chart-line"></i>
            Estad√≠sticas
          </h6>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üí∞</div>
              <div class="stat-value">{{ context?.stats?.totalSpent | number:'1.2-2' }}‚Ç¨</div>
              <div class="stat-label">Total gastado</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üì¶</div>
              <div class="stat-value">{{ context?.stats?.activeOrders }}</div>
              <div class="stat-label">Pedidos activos</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">‚úÖ</div>
              <div class="stat-value">{{ context?.stats?.completedOrders }}</div>
              <div class="stat-label">Completados</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">‚Ü©Ô∏è</div>
              <div class="stat-value">{{ context?.stats?.returns }}</div>
              <div class="stat-label">Devoluciones</div>
            </div>
          </div>
        </section>
      </div>

      <!-- ORDERS TAB -->
      <div class="tab-pane" *ngIf="activeTab === 'orders' && context" style="display: block;">
        
        <div class="empty-state" *ngIf="context?.activeOrders?.length === 0">
          <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
          <p class="text-muted">No hay pedidos activos</p>
        </div>

        <div class="orders-list" *ngIf="context?.activeOrders?.length > 0">
          <div class="order-card" *ngFor="let order of context.activeOrders">
            
            <div class="order-header">
              <div class="order-id-section">
                <span class="order-id">#{{ order.id }}</span>
                <!-- Mostrar status si existe, sino printfulStatus -->
                <span class="badge badge-sm" [ngClass]="getStatusClass(order.status || order.printfulStatus)">
                  {{ order.status ? translateStatus(order.status) : translatePrintfulStatus(order.printfulStatus) }}
                </span>
              </div>
              <button class="btn-icon" (click)="viewOrderDetail(order.id)" title="Ver detalle">
                <i class="fas fa-external-link-alt"></i>
              </button>
            </div>

            <div class="order-body">
              <div class="order-info">
                <div class="info-item">
                  <i class="fas fa-calendar-alt text-muted"></i>
                  <span>{{ formatDate(order.createdAt) }}</span>
                </div>
                <div class="info-item">
                  <i class="fas fa-euro-sign text-muted"></i>
                  <span>{{ (order.total || order.amount) | number:'1.2-2' }}‚Ç¨</span>
                </div>
              </div>

              <!-- Printful Info -->
              <div class="printful-section" *ngIf="order.printfulOrderId">
                <div class="printful-header">
                  <i class="fas fa-print text-primary"></i>
                  <span class="printful-label">Printful #{{ order.printfulOrderId }}</span>
                  
                  <!-- FASE 2A: Badge de retraso -->
                  <span 
                    *ngIf="isOrderDelayed(order)" 
                    class="badge badge-danger badge-sm ml-2"
                    title="Pedido retrasado">
                    <i class="fas fa-clock"></i> Retraso ({{ getDaysDelayed(order) }}d)
                  </span>
                </div>
                <div class="printful-details">
                  <div class="detail-row" *ngIf="order.minDeliveryDate && order.maxDeliveryDate">
                    <small class="text-muted">üìÖ Entrega estimada:</small>
                    <small>{{ formatDate(order.minDeliveryDate) }} - {{ formatDate(order.maxDeliveryDate) }}</small>
                  </div>
                  <div class="detail-row" *ngIf="order.trackingNumber">
                    <small class="text-muted">üìç Tracking:</small>
                    <small class="text-primary">{{ order.trackingNumber }}</small>
                  </div>
                  
                  <!-- FASE 2A: Estado de Printful en tiempo real -->
                  <div class="detail-row" *ngIf="order.printfulData">
                    <small class="text-muted">üîÑ Estado actual:</small>
                    <small>{{ getPrintfulStatusLabel(order.printfulData.status) }}</small>
                  </div>
                </div>
              </div>
            </div>

            <div class="order-actions">
              <button class="btn btn-sm btn-outline-primary" (click)="sendOrderInfoToChat(order)">
                <i class="fas fa-paper-plane me-1"></i> Enviar info
              </button>
              
              <!-- FASE 2A: Botones nuevos para Printful -->
              <div *ngIf="isPrintfulOrder(order)" class="printful-actions mt-2">
                <button 
                  class="btn btn-sm btn-light-info"
                  (click)="refreshPrintfulOrder(order)"
                  [disabled]="loadingPrintfulData"
                  title="Refrescar estado desde Printful">
                  <i class="fas fa-sync-alt" [class.fa-spin]="loadingPrintfulData"></i>
                  Refrescar estado
                </button>
                
                <button 
                  *ngIf="hasTracking(order)"
                  class="btn btn-sm btn-light-primary ml-2"
                  (click)="openExternalTracking(order)"
                  title="Ver tracking en transportista">
                  <i class="fas fa-shipping-fast"></i>
                  Ver tracking
                </button>

                <button 
                  class="btn btn-sm btn-light-success ml-2"
                  (click)="openTrackingTab(order)"
                  title="Ver timeline completo">
                  <i class="fas fa-list-alt"></i>
                  Timeline
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- RETURNS TAB -->
      <div class="tab-pane" *ngIf="activeTab === 'returns' && context" style="display: block;">
        
        <div class="empty-state" *ngIf="context?.returns?.length === 0">
          <i class="fas fa-undo-alt fa-3x text-muted mb-3"></i>
          <p class="text-muted">No hay devoluciones registradas</p>
          <button class="btn btn-sm btn-primary mt-2" (click)="createReturn()">
            <i class="fas fa-plus me-1"></i> Crear devoluci√≥n
          </button>
        </div>

        <div class="returns-list" *ngIf="context?.returns?.length > 0">
          <div class="return-card" *ngFor="let return of context.returns">
            <div class="return-header">
              <span class="return-id">#{{ return.id }}</span>
              <span class="badge" [ngClass]="getStatusClass(return.status)">
                {{ return.status }}
              </span>
            </div>
            <div class="return-body">
              <p class="mb-1"><strong>Pedido:</strong> #{{ return.sale_id }}</p>
              <p class="mb-1"><strong>Motivo:</strong> {{ return.reason || 'No especificado' }}</p>
              <p class="mb-0 text-muted"><small>{{ formatDate(return.createdAt) }}</small></p>
            </div>
          </div>
        </div>
      </div>

      <!-- FASE 2A: TRACKING TAB -->
      <div class="tab-pane" *ngIf="activeTab === 'tracking' && selectedOrderForTracking" style="display: block;">
        <app-tracking-tab
          [orderId]="selectedOrderForTracking.id"
          [printfulOrderId]="selectedOrderForTracking.printfulOrderId"
          (onRefresh)="onTrackingRefresh()">
        </app-tracking-tab>
      </div>

      <!-- ‚úÖ FASE 2B: ASISTENTE IA TAB -->
      <div class="tab-pane assistant-tab" *ngIf="activeTab === 'assistant'" style="display: block;">
        
        <!-- Contenido del Panel Inteligente -->
        <div class="ai-assistant-panel" 
             [ngClass]="'intent-' + (aiAssistantData?.intent?.type || 'default').toLowerCase()"
             *ngIf="aiAssistantData && aiAssistantData.templates && aiAssistantData.templates.length > 0">
          
          <!-- Header -->
          <div class="panel-header">
            <div class="title">
              <i class="fas fa-magic text-warning me-2"></i>
              <strong>Respuestas Sugeridas</strong>
              <span class="badge badge-primary ms-2">
                {{ aiAssistantData.templates.length }} plantilla<span *ngIf="aiAssistantData.templates.length > 1">s</span>
              </span>
            </div>
          </div>

          <!-- Template Selector (Chips) -->
          <div class="template-selector" *ngIf="aiAssistantData.templates.length > 1">
            <div 
              *ngFor="let template of aiAssistantData.templates; let i = index" 
              class="template-chip"
              [class.selected]="aiAssistantData.selectedIndex === i"
              (click)="onTemplateSelect(i)">
              <span class="chip-icon" [ngClass]="'chip-' + template.type">
                <i class="fas" [ngClass]="{
                  'fa-box': template.type === 'default',
                  'fa-truck': template.type === 'tracking',
                  'fa-exclamation-triangle': template.type === 'delay',
                  'fa-times-circle': template.type === 'cancel',
                  'fa-undo': template.type === 'return'
                }"></i>
              </span>
              <span class="chip-label">{{ getTemplateLabel(template.type) }}</span>
              <span class="chip-confidence">{{ (template.confidence * 100).toFixed(0) }}%</span>
            </div>
          </div>

          <!-- Selected Template Preview -->
          <div class="panel-body" *ngIf="aiAssistantData.selectedIndex !== null && aiAssistantData.templates[aiAssistantData.selectedIndex]">
            <div class="template-preview">
              <!-- Texto T√©cnico (Admin) -->
              <div class="preview-section mb-3">
                <div class="preview-label">
                  <small class="text-muted">
                    <i class="fas fa-user-shield me-1"></i><strong>Vista t√©cnica (Admin):</strong>
                  </small>
                </div>
                <div class="suggested-message admin-view">
                  <pre>{{ aiAssistantData.templates[aiAssistantData.selectedIndex].text }}</pre>
                </div>
              </div>

              <!-- Texto Sugerido para Cliente (si existe) -->
              <div class="preview-section" *ngIf="aiAssistantData.templates[aiAssistantData.selectedIndex].customerFriendlyText">
                <div class="preview-label">
                  <small class="text-muted">
                    <i class="fas fa-comment-dots me-1"></i><strong>Sugerencia para el cliente:</strong>
                  </small>
                </div>
                <div class="suggested-message customer-view">
                  <pre>{{ aiAssistantData.templates[aiAssistantData.selectedIndex].customerFriendlyText }}</pre>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="action-buttons mt-3" *ngIf="aiAssistantData.templates[aiAssistantData.selectedIndex].actionButtons?.length">
                <small class="text-muted d-block mb-2">
                  <i class="fas fa-mouse-pointer"></i> <strong>Acciones r√°pidas:</strong>
                </small>
                <div class="btn-group btn-group-sm">
                  <button 
                    *ngFor="let btn of aiAssistantData.templates[aiAssistantData.selectedIndex].actionButtons" 
                    class="btn"
                    [ngClass]="'btn-light-' + btn.variant"
                    title="{{ btn.label }}">
                    {{ btn.label }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions Footer -->
          <div class="panel-actions">
            <button 
              class="btn btn-sm btn-light-primary" 
              (click)="onInsertTemplate()"
              [disabled]="aiAssistantData.selectedIndex === null"
              title="Insertar en editor">
              <i class="fas fa-edit me-1"></i> Insertar
            </button>
            
            <button 
              class="btn btn-sm btn-success" 
              (click)="onSendTemplate()"
              [disabled]="aiAssistantData.selectedIndex === null"
              title="Enviar directamente">
              <i class="fas fa-paper-plane me-1"></i> Enviar
            </button>
          </div>
        </div>

        <!-- Estado vac√≠o -->
        <div class="ai-assistant-empty" *ngIf="!aiAssistantData || !aiAssistantData.templates || aiAssistantData.templates.length === 0">
          <p class="text-muted text-center py-4">
            <i class="fas fa-magic fa-2x mb-3 d-block"></i>
            El asistente IA se activar√° autom√°ticamente cuando detecte intenciones del cliente.
          </p>
          <p class="text-muted text-center small">
            Detecta: Estado del pedido, Tracking, Problemas de entrega, Cancelaciones, etc.
          </p>
        </div>
      </div>

    </div>

  </div>

</div>
