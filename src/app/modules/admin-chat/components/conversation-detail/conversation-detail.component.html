<!-- TEMPLATE ORIGINAL -->
<!-- <div class="conv-detail">
    <div *ngIf="!selected" class="empty-panel">Selecciona una conversación para empezar</div>
    <div *ngIf="selected" class="detail-wrap">
        <div class="detail-header">
            <div class="left">
                <h4>Conversación #{{ selected.id }}</h4>
                <div class="meta">Usuario: {{ selected.user_id || selected.guest_id || selected.session_id }} • Estado: {{ selected.status }} • Agente: {{ selected.agent_name || 'Sin asignar' }}</div>
            </div>
            <div class="right">
                <div class="dates">Creada: {{ selected.createdAt | date:'short' }} • Actualizada: {{ selected.updatedAt | date:'short' }}</div>
                <div class="controls">
                    <button class="btn btn-sm btn-outline-secondary" (click)="closeConversation()">Cerrar</button>
                    <button class="btn btn-sm btn-outline-success" (click)="takeConversation()">Tomar / Reabrir</button>
                </div>
            </div>
        </div>

        <div #messagesContainer class="messages">
            <div *ngFor="let m of messages" class="msg" [ngClass]="{'agent': m.sender_type==='agent', 'user': m.sender_type==='user'}">
                <div class="meta">{{ m.sender_type }} • {{ m.timestamp | date:'shortTime' }}</div>
                <div class="content">{{ m.message }}</div>
            </div>
        </div>

        <div class="send-box">
            <textarea [(ngModel)]="newMessage" rows="3" placeholder="Escribir mensaje..."></textarea>
            <div class="actions">
                <button class="btn btn-sm btn-primary" (click)="send()">Enviar</button>
            </div>
        </div>
    </div>
</div> -->
<!-- END TEMPLATE ORIGINAL -->






<!-- NUEVO STYLE -->

<!--begin::Content-->
<!-- <div class="flex-lg-row-fluid ms-lg-7 ms-xl-10" *ngIf="selected; else emptyState"> -->
<div class="conversation-layout" *ngIf="chat.selectedConversation$ | async as selected; else emptyState">
    
    <!-- COLUMNA PRINCIPAL: Chat -->
    <div class="flex-lg-row-fluid chat-wrapper">
        <div class="chat-card" id="kt_chat_messenger">

            <!-- ✅ HEADER ENTERPRISE SIMPLIFICADO -->
            <header class="chat-header">
                <!-- Información del usuario (izquierda) -->
                <div class="header-user-info">
                    <div class="user-avatar">
                        <span class="avatar-initial">{{ getUserDisplayName(selected)[0].toUpperCase() }}</span>
                        <span class="status-dot" [class.online]="selected.status === 'open'"></span>
                    </div>
                    <div class="user-meta">
                        <h3 class="user-name">{{ getUserDisplayName(selected) }}</h3>
                        <p class="user-status">
                            <span class="status-badge" [attr.data-status]="selected.status">
                                {{ selected.status === 'open' ? 'Activa' : selected.status === 'closed' ? 'Cerrada' : 'Pendiente' }}
                            </span>
                            <span class="separator">•</span>
                            <span class="agent-name">
                                {{ selected.agent_name ? ('Agente: ' + selected.agent_name) : 'Sin agente asignado' }}
                            </span>
                        </p>
                    </div>
                </div>

                <!-- Acciones (derecha) -->
                <div class="header-actions">
                    <!-- Botones principales con mejor espaciado -->
                    <button 
                        class="action-btn btn-take" 
                        (click)="takeConversation()" 
                        [title]="selected.agent_id ? 'Reasignar conversación a ti' : 'Asignarme esta conversación'"
                        *ngIf="selected.status !== 'closed'">
                        <i class="fas fa-user-check"></i>
                        <span class="btn-text">{{ selected.agent_id ? 'Reasignar' : 'Tomar' }}</span>
                    </button>
                    
                    <button 
                        class="action-btn btn-close" 
                        (click)="closeConversation()" 
                        title="Marcar conversación como cerrada"
                        *ngIf="selected.status !== 'closed'">
                        <i class="fas fa-check-circle"></i>
                        <span class="btn-text">Cerrar</span>
                    </button>

                    <button 
                        class="action-btn btn-reopen" 
                        (click)="takeConversation()" 
                        title="Reabrir y tomar conversación"
                        *ngIf="selected.status === 'closed'">
                        <i class="fas fa-redo"></i>
                        <span class="btn-text">Reabrir</span>
                    </button>

                    <!-- Menú desplegable -->
                    <div class="dropdown-menu-wrapper" clickOutside (clickOutside)="menuOpen = false">
                        <button class="action-btn btn-more" (click)="toggleMenu(); $event.stopPropagation()" title="Más opciones">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>

                        <!-- Menú flotante limpio -->
                        <div class="dropdown-menu" *ngIf="menuOpen">
                            <button class="menu-item" (click)="showUserInfo(selected); menuOpen = false">
                                <i class="fas fa-user"></i>
                                <span>Ver información del usuario</span>
                            </button>
                            <button class="menu-item" (click)="viewOrderHistory(selected); menuOpen = false">
                                <i class="fas fa-shopping-bag"></i>
                                <span>Historial de pedidos</span>
                            </button>
                            <button class="menu-item" (click)="handleReturnRequest(selected); menuOpen = false">
                                <i class="fas fa-undo-alt"></i>
                                <span>Gestionar devolución</span>
                            </button>
                            <div class="menu-divider"></div>
                            <button class="menu-item text-muted" disabled>
                                <i class="fas fa-hashtag"></i>
                                <span>ID: #{{ selected.id }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

        <!-- BODY -->
        <section class="chat-body" #messagesContainer>
            <div class="messages-inner">
                <div *ngFor="let m of messages" class="message-group" [ngClass]="{ 'from-agent': m.sender_type==='agent', 'from-user': m.sender_type==='user' }">

                    <ng-container *ngIf="m.sender_type === 'user'">
                        <div class="message-row user-row">
                            <img class="avatar" [src]="getAvatar('user')" alt="Usuario" (error)="onAvatarError('user')" [hidden]="showFallback.user">
                            <span class="symbol-label avatar-circle fallback-avatar" *ngIf="showFallback.user">U</span>
                            <!-- <span class="symbol-label avatar-circle">{{ userInitial }}</span> -->
                            <div class="bubble-wrapper">
                                <div class="bubble bubble-user">{{ m.message }}</div>
                                <div class="msg-meta"><span class="sender">Usuario</span> • <span class="time">{{ getDateFromTime(m.timestamp) | date:'shortTime' }}</span></div>
                            </div>
                        </div>
                    </ng-container>

                    <ng-container *ngIf="m.sender_type === 'agent'">
                        <div class="message-row agent-row">
                            <div class="bubble-wrapper">
                                <div class="bubble bubble-agent">{{ m.message }}</div>
                                <div class="msg-meta text-end"><span class="time">{{ getDateFromTime(m.timestamp) | date:'shortTime' }}</span> • <span class="sender">Tú</span></div>
                            </div>
                            <!-- <img class="avatar" alt="agent" src="assets/media/avatars/agent-avatar.png"> -->
                            <img class="avatar" [src]="getAvatar('agent')" alt="Agente" (error)="onAvatarError('agent')" [hidden]="showFallback.agent">
                            <span class="symbol-label avatar-circle fallback-avatar" *ngIf="showFallback.agent">A</span>
                        </div>
                    </ng-container>

                </div>
            </div>
            <!-- typing indicator stays visible if isTyping is true -->
            <div class="typing" *ngIf="isTyping">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </section>

        <!-- ✅ FASE 2B: Panel inteligente movido al panel derecho (customer-context-sidebar) como nueva tab "Asistente IA" -->

        <!-- FOOTER -->
        <footer class="chat-footer">
            <!-- ✅ Intent Detection Badge -->
            <div class="intent-badge-container" *ngIf="lastDetectedIntent && intentService.isHighConfidence(lastDetectedIntent)">
                <div class="intent-badge" [ngClass]="'badge-' + intentService.getIntentColor(lastDetectedIntent)">
                    <i class="fas fa-lightbulb me-1"></i>
                    {{ intentService.getIntentLabel(lastDetectedIntent) }}
                    <span class="confidence-score">({{ (lastDetectedIntent.confidence * 100) | number:'1.0-0' }}%)</span>
                </div>
            </div>

            <div class="input-wrap">
                <button class="icon-btn btn-ghost" title="Adjuntar"><i class="ki-duotone ki-attachment"></i></button>
                <input type="text" class="chat-input" [(ngModel)]="newMessage" placeholder="Escribe un mensaje..." (keydown.enter)="send()" />
                <button class="send-btn" (click)="send()">
                    <svg fill="#000000" viewBox="0 0 32 32" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;fill: currentColor; width: 25px; height: 25px;" version="1.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:serif="http://www.serif.com/" xmlns:xlink="http://www.w3.org/1999/xlink" transform="rotate(45)">
                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                        <g id="SVGRepo_iconCarrier">
                            <path d="M11.499,19.173l5.801,-5.849c0.389,-0.392 1.022,-0.394 1.414,-0.006c0.392,0.389 0.395,1.022 0.006,1.414l-5.798,5.847l5.306,8.002c0.207,0.313 0.572,0.483 0.945,0.441c0.373,-0.042 0.691,-0.289 0.824,-0.64l9.024,-23.904c0.138,-0.366 0.05,-0.78 -0.226,-1.058c-0.276,-0.278 -0.689,-0.369 -1.057,-0.233l-24.004,8.892c-0.353,0.13 -0.602,0.448 -0.646,0.821c-0.044,0.373 0.125,0.74 0.438,0.948l7.973,5.325Z"></path>
                            <g id="Icon"></g>
                        </g>
                    </svg>
                </button>
            </div>
        </footer>

        </div>
    </div>

    <!-- ✅ COLUMNA DERECHA: Customer Context Panel -->
    <aside class="customer-context-sidebar" #contextSidebar>
        <app-customer-context-panel 
            [context]="customerContext"
            [conversationId]="selected?.id"
            [conversation]="selected"
            [aiAssistantData]="aiAssistantPanelData"
            (templateSelected)="selectTemplate($event)"
            (templateInserted)="insertTemplateAsDraft()"
            (templateSent)="sendSelectedTemplate()">
        </app-customer-context-panel>
    </aside>

</div>

<!-- Estado vacío -->
<ng-template #emptyState>
    <div class="empty-state-container">
        <div class="empty-state-content">
            <div class="empty-icon">
                <i class="fas fa-comments"></i>
            </div>
            <h3 class="empty-title">Bandeja de conversaciones</h3>
            <p class="empty-description">Selecciona una conversación de la lista para ver los detalles y comenzar a chatear con tus clientes.</p>
            <div class="empty-features">
                <div class="feature-item">
                    <i class="fas fa-check-circle"></i>
                    <span>Respuestas en tiempo real</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-user-shield"></i>
                    <span>Información del cliente</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-robot"></i>
                    <span>Asistente IA disponible</span>
                </div>
            </div>
        </div>
    </div>
</ng-template>