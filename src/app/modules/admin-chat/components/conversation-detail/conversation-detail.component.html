<!-- TEMPLATE ORIGINAL -->
<!-- <div class="conv-detail">
    <div *ngIf="!selected" class="empty-panel">Selecciona una conversación para empezar</div>
    <div *ngIf="selected" class="detail-wrap">
        <div class="detail-header">
            <div class="left">
                <h4>Conversación #{{ selected.id }}</h4>
                <div class="meta">Usuario: {{ selected.user_id || selected.guest_id || selected.session_id }} • Estado: {{ selected.status }} • Agente: {{ selected.agent_name || 'Sin asignar' }}</div>
            </div>
            <div class="right">
                <div class="dates">Creada: {{ selected.createdAt | date:'short' }} • Actualizada: {{ selected.updatedAt | date:'short' }}</div>
                <div class="controls">
                    <button class="btn btn-sm btn-outline-secondary" (click)="closeConversation()">Cerrar</button>
                    <button class="btn btn-sm btn-outline-success" (click)="takeConversation()">Tomar / Reabrir</button>
                </div>
            </div>
        </div>

        <div #messagesContainer class="messages">
            <div *ngFor="let m of messages" class="msg" [ngClass]="{'agent': m.sender_type==='agent', 'user': m.sender_type==='user'}">
                <div class="meta">{{ m.sender_type }} • {{ m.timestamp | date:'shortTime' }}</div>
                <div class="content">{{ m.message }}</div>
            </div>
        </div>

        <div class="send-box">
            <textarea [(ngModel)]="newMessage" rows="3" placeholder="Escribir mensaje..."></textarea>
            <div class="actions">
                <button class="btn btn-sm btn-primary" (click)="send()">Enviar</button>
            </div>
        </div>
    </div>
</div> -->
<!-- END TEMPLATE ORIGINAL -->






<!-- NUEVO STYLE -->

<!--begin::Content-->
<!-- <div class="flex-lg-row-fluid ms-lg-7 ms-xl-10" *ngIf="selected; else emptyState"> -->
<div class="flex-lg-row-fluid ms-lg-7 ms-xl-10 chat-wrapper" *ngIf="chat.selectedConversation$ | async as selected; else emptyState">
  <div class="chat-card" id="kt_chat_messenger">

    <!-- HEADER -->
    <header class="chat-header">
      <div class="left">
        <div class="symbol symbol-48px me-3">
          <span class="symbol-label avatar-circle">{{ userInitial }}</span>
        </div>
        <div class="meta">
          <div class="name">{{ selected.user_name || 'Usuario' }}</div>
          <div class="status text-muted">{{ selected.status || 'Sin estado' }} • <span class="agent text-primary">{{ selected.agent_name || 'Sin asignar' }}</span></div>
        </div>
      </div>

      <div class="right">
        <div class="actions">
          <button class="btn btn-sm btn-ghost-danger" (click)="closeConversation()">Cerrar</button>
          <button class="btn btn-sm btn-ghost-success" (click)="takeConversation()">Tomar</button>
          <button class="btn btn-sm btn-ghost" (click)="showUserInfo()">Ver usuario</button>
        </div>
        <div class="conv-id text-muted">#{{ selected.id }}</div>
      </div>
    </header>

    <!-- BODY -->
    <section class="chat-body" #messagesContainer>
      <div class="messages-inner">
        <div *ngFor="let m of messages" class="message-group" [ngClass]="{ 'from-agent': m.sender_type==='agent', 'from-user': m.sender_type==='user' }">

          <ng-container *ngIf="m.sender_type === 'user'">
            <div class="message-row user-row">
              <img 
                class="avatar" 
                [src]="getAvatar('user')" 
                alt="Usuario"
                (error)="onAvatarError('user')"
                [hidden]="showFallback.user"
              >
              <span  class="symbol-label avatar-circle fallback-avatar"  *ngIf="showFallback.user">U</span>
              <!-- <span class="symbol-label avatar-circle">{{ userInitial }}</span> -->
              <div class="bubble-wrapper">
                <div class="bubble bubble-user">{{ m.message }}</div>
                <div class="msg-meta"><span class="sender">Usuario</span> • <span class="time">{{ getDateFromTime(m.timestamp) | date:'shortTime' }}</span></div>
              </div>
            </div>
          </ng-container>

          <ng-container *ngIf="m.sender_type === 'agent'">
            <div class="message-row agent-row">
              <div class="bubble-wrapper">
                <div class="bubble bubble-agent">{{ m.message }}</div>
                <div class="msg-meta text-end"><span class="time">{{ getDateFromTime(m.timestamp) | date:'shortTime' }}</span> • <span class="sender">Tú</span></div>
              </div>
              <!-- <img class="avatar" alt="agent" src="assets/media/avatars/agent-avatar.png"> -->
              <img 
                class="avatar" 
                [src]="getAvatar('agent')" 
                alt="Agente"
                (error)="onAvatarError('agent')"
                [hidden]="showFallback.agent"
              >
              <span  class="symbol-label avatar-circle fallback-avatar"  *ngIf="showFallback.agent">A</span>
            </div>
          </ng-container>

        </div>
      </div>
      <!-- typing indicator stays visible if isTyping is true -->
      <div class="typing" *ngIf="isTyping">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="chat-footer">
      <div class="input-wrap">
        <button class="icon-btn btn-ghost" title="Adjuntar"><i class="ki-duotone ki-attachment"></i></button>
        <input type="text" class="chat-input" [(ngModel)]="newMessage" placeholder="Escribe un mensaje..." (keydown.enter)="send()" />
        <button class="send-btn" (click)="send()"><i class="ki-duotone ki-send fs-1"></i></button>
      </div>
    </footer>

  </div>
</div>

<!-- Estado vacío -->
<ng-template #emptyState>
  <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
    <i class="ki-duotone ki-message-square fs-2hx mb-4 opacity-50"></i>
    <div class="fs-5 fw-semibold">Selecciona una conversación para empezar</div>
  </div>
</ng-template>

